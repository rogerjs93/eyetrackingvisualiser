<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking Data Visualizer - AI-Powered Analysis</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="baseline_model_web.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        /* Circular Text Animation */
        .circular-text-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto;
            animation: fadeInUp 1s ease-out;
        }
        
        .circular-text {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 20s linear infinite;
        }
        
        .circular-text span {
            position: absolute;
            left: 50%;
            top: 0;
            transform-origin: 0 200px;
            font-size: 1.3em;
            font-weight: 600;
            opacity: 0;
            animation: letterFadeIn 0.5s ease-out forwards;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes letterFadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Floating background elements */
        .header::before,
        .header::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .header::before {
            width: 300px;
            height: 300px;
            background: white;
            top: -150px;
            left: -100px;
            animation-delay: 0s;
        }
        
        .header::after {
            width: 200px;
            height: 200px;
            background: white;
            bottom: -100px;
            right: -50px;
            animation-delay: 3s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-top: 10px;
            position: relative;
            z-index: 2;
            animation: fadeIn 1.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 0.95; }
        }
        
        .header .beta-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px 5px rgba(255, 255, 255, 0);
            }
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-2px);
        }
        
        .tab-button:hover::after {
            width: 80%;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: transparent;
            background: white;
        }
        
        .tab-button.active::after {
            width: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .tab-icon {
            font-size: 1.3em;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Info Cards */
        .info-card {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            opacity: 0;
            animation: slideInLeft 0.6s ease-out forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-card h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        
        .info-card ul {
            margin-left: 20px;
            color: #495057;
        }
        
        .info-card li {
            margin: 5px 0;
        }
        
        /* Controls */
        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
            transition: all 0.3s ease;
        }
        
        .control-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .control-item select,
        .control-item input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* File Upload */
        .file-upload {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload.drag-over {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        /* Results Display */
        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        .interpretation {
            text-align: center;
            font-size: 1.2em;
            color: #495057;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
        }
        
        /* Plots */
        .plot-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            color: #6c757d;
            margin-top: 10px;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        /* Footer */
        .footer {
            background: #343a40;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* Age Info Sections */
        .age-info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .age-info-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .age-info-section li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        /* Toast Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        
        .toast {
            background: white;
            padding: 16px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid;
        }
        
        .toast.success { border-color: #28a745; }
        .toast.error { border-color: #dc3545; }
        .toast.warning { border-color: #ffc107; }
        .toast.info { border-color: #17a2b8; }
        
        .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex-grow: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover { opacity: 1; }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            backdrop-filter: blur(5px);
        }
        
        .loading-content {
            text-align: center;
            max-width: 500px;
            padding: 40px;
        }
        
        .spinner-large {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        .loading-steps {
            margin-top: 30px;
            text-align: left;
        }
        
        .step {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            transition: all 0.3s;
            opacity: 0.4;
        }
        
        .step.active {
            opacity: 1;
            background: #e7f3ff;
            font-weight: 600;
        }
        
        .step.completed {
            opacity: 0.7;
            color: #28a745;
        }
        
        /* File Upload Progress */
        .upload-progress {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .progress-text {
            font-size: 0.9em;
            color: #495057;
            text-align: center;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 12px;
            background: #e7f3ff;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            display: none;
        }
        
        .file-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        /* Form Validation */
        .control-item input:invalid,
        .control-item input.error,
        .control-item select.error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        .control-item input:valid.validated {
            border-color: #28a745;
        }
        
        .field-hint {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 4px;
            display: block;
        }
        
        .field-error {
            font-size: 0.85em;
            color: #dc3545;
            margin-top: 4px;
            display: none;
            font-weight: 500;
        }
        
        .help-icon {
            cursor: help;
            font-size: 0.9em;
            color: #6c757d;
            margin-left: 4px;
            position: relative;
        }
        
        .help-icon::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #343a40;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.85em;
            font-weight: normal;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .help-icon:hover::before {
            opacity: 1;
        }
        
        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .example-format {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            text-align: left;
            display: inline-block;
        }
        
        .example-format code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        /* Plot Controls */
        .plot-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: -10px;
        }
        
        .btn-icon {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }
        
        .btn-icon:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .plot-info {
            display: flex;
            gap: 8px;
        }
        
        .info-badge {
            padding: 4px 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
        }
        
        /* Enhanced AI Results */
        .results-container {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .score-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e7f3ff 100%);
            text-align: center;
            padding: 30px;
        }
        
        .score-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .score-text {
            font-size: 48px;
            font-weight: bold;
            fill: #667eea;
        }
        
        .interpretation-enhanced {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .interpretation-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 1s ease;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .metric-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        
        .metric-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .metric-icon {
            font-size: 2em;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #495057;
        }
        
        /* Footer Citations */
        .citation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .citation-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .citation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .citation-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .citation-card p {
            color: #6c757d;
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .citation-card a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .citation-card a:hover {
            text-decoration: underline;
        }
        
        /* Performance Optimizations */
        .circular-text {
            will-change: transform;
            transform: translateZ(0);
        }
        
        .animated-title span,
        .info-card,
        .control-section {
            will-change: opacity, transform;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .circular-text-container {
                width: 280px;
                height: 280px;
            }
            
            .circular-text span {
                font-size: 1.1em;
            }
            
            .tab-button {
                font-size: 0.9em;
                padding: 15px 10px;
            }
            
            .tab-icon {
                display: none;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .citation-cards {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .circular-text-container {
                width: 220px;
                height: 220px;
            }
            
            .circular-text span {
                font-size: 0.9em;
                transform-origin: 0 110px;
            }
            
            .loading-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-large"></div>
            <h3 id="loading-title">Processing...</h3>
            <p id="loading-message">Please wait while we process your data</p>
            <div class="loading-steps" id="loading-steps">
                <div class="step" id="step-1">‚è≥ Initializing...</div>
                <div class="step" id="step-2">‚è≥ Processing data...</div>
                <div class="step" id="step-3">‚è≥ Analyzing patterns...</div>
                <div class="step" id="step-4">‚è≥ Generating results...</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="circular-text-container" id="circularTextContainer"></div>
            <p>AI-Powered Analysis with Age-Specific ASD Baselines</p>
            <div class="beta-badge">‚ú® TensorFlow.js AI Features</div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('quick-start')">
                <span class="tab-icon">‚ö°</span>
                <span>Quick Start</span>
            </button>
            <button class="tab-button" onclick="switchTab('upload-data')">
                <span class="tab-icon">üì§</span>
                <span>Upload CSV</span>
            </button>
            <button class="tab-button" onclick="switchTab('ai-analysis')">
                <span class="tab-icon">ü§ñ</span>
                <span>AI Analysis</span>
            </button>
        </div>
        
        <!-- Tab 1: Quick Start (Synthetic Data) -->
        <div id="quick-start" class="tab-content active">
            <div class="info-card">
                <h3>‚ú® Quick Start with Synthetic Data</h3>
                <ul>
                    <li>Generate realistic eye-tracking patterns instantly</li>
                    <li>Explore different visualization types</li>
                    <li>Perfect for testing and demonstrations</li>
                </ul>
            </div>
            
            <div class="control-section">
                <h3>Visualization Settings</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="plot-type">Plot Type:</label>
                        <select id="plot-type">
                            <option value="scatter">Scatter Plot</option>
                            <option value="heatmap">Heatmap</option>
                            <option value="path">Scan Path</option>
                            <option value="histogram">Histogram</option>
                            <option value="density">Density Contour</option>
                            <option value="3d">3D Trajectory</option>
                            <option value="temporal">Temporal Analysis</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label for="num-points">
                            Number of Points:
                            <span class="help-icon" data-tooltip="More points = slower rendering">‚ìò</span>
                        </label>
                        <input type="number" id="num-points" value="100" min="10" max="1000" class="form-input">
                        <span class="field-hint">10-1000 points (recommended: 100-500)</span>
                        <span class="field-error" id="num-points-error">Please enter a value between 10 and 1000</span>
                    </div>
                    
                    <div class="control-item">
                        <label for="pattern-type">
                            Pattern Type:
                            <span class="help-icon" data-tooltip="Select eye movement pattern">‚ìò</span>
                        </label>
                        <select id="pattern-type">
                            <option value="random">Random</option>
                            <option value="focused">Focused</option>
                            <option value="scanning">Scanning</option>
                            <option value="reading">Reading</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateData()">
                        üé≤ Generate Synthetic Data
                    </button>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="quick-plot-empty" class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3>Ready to Explore Eye-Tracking Data</h3>
                <p>Generate synthetic data to see visualization options</p>
                <button class="btn btn-primary" onclick="generateData()">
                    üé≤ Generate Sample Data
                </button>
            </div>
            
            <div class="plot-container" id="quick-plot-container" style="display: none;">
                <div class="plot-controls">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-icon" onclick="downloadPlot('quick-plot')" title="Download as PNG">
                            üì• Download
                        </button>
                        <button class="btn-icon" onclick="resetZoom('quick-plot')" title="Reset View">
                            üîÑ Reset
                        </button>
                    </div>
                    <div class="plot-info">
                        <span class="info-badge" title="Click and drag to zoom">üîç Zoom</span>
                        <span class="info-badge" title="Double-click to reset">‚Ü∫ Reset</span>
                    </div>
                </div>
                <div id="quick-plot"></div>
            </div>
        </div>
        
        <!-- Tab 2: Upload CSV Data -->
        <div id="upload-data" class="tab-content">
            <div class="info-card">
                <h3>üì§ Upload Your Eye-Tracking Data</h3>
                <ul>
                    <li>CSV file format required: timestamp, x, y coordinates</li>
                    <li>Optional columns: fixation_duration, pupil_size</li>
                    <li>Data will be processed in your browser (secure & private)</li>
                </ul>
            </div>
            
            <div class="file-upload" id="file-upload-area">
                <div class="file-upload-icon">üìÅ</div>
                <h3>Drag & Drop CSV File</h3>
                <p>or click to browse</p>
                <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            
            <!-- Upload Progress -->
            <div class="upload-progress" id="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p class="progress-text">Parsing CSV: <span id="progress-percent">0%</span></p>
            </div>
            
            <!-- File Info -->
            <div class="file-info" id="file-info">
                <p><strong>üìÑ File:</strong> <span id="filename"></span></p>
                <p><strong>üì¶ Size:</strong> <span id="filesize"></span></p>
                <p><strong>üìä Rows:</strong> <span id="filerows"></span></p>
            </div>
            
            <div id="upload-status" class="status-message"></div>
            
            <!-- Empty State for Upload -->
            <div id="upload-empty" class="empty-state">
                <div class="empty-state-icon">üì§</div>
                <h3>No Data Uploaded Yet</h3>
                <p>Drop a CSV file above or click to browse</p>
                <div class="example-format">
                    <p><strong>Expected format:</strong></p>
                    <code>timestamp, x, y, fixation_duration, pupil_size</code>
                </div>
            </div>
            
            <div id="upload-results" style="display: none;">
                <div class="results-container">
                    <div class="result-card">
                        <h4>üìä Data Summary</h4>
                        <div id="data-summary"></div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Visualization Settings</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label for="upload-plot-type">Plot Type:</label>
                            <select id="upload-plot-type">
                                <option value="scatter">Scatter Plot</option>
                                <option value="heatmap">Heatmap</option>
                                <option value="path">Scan Path</option>
                                <option value="histogram">Histogram</option>
                                <option value="density">Density Contour</option>
                                <option value="3d">3D Trajectory</option>
                                <option value="temporal">Temporal Analysis</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label for="coordinate-mode">
                                Coordinate Mode:
                                <span class="help-icon" data-tooltip="Raw for stimulus overlay, Normalized for AI">‚ìò</span>
                            </label>
                            <select id="coordinate-mode" onchange="updateCoordinateMode()">
                                <option value="raw">Raw Coordinates (for stimulus overlay)</option>
                                <option value="normalized">Normalized 0-100 (for AI comparison)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="visualizeUploadedData()">
                            üìä Visualize Data
                        </button>
                        <button class="btn btn-secondary" onclick="compareToBaseline()">
                            ü§ñ Compare to AI Baseline
                        </button>
                    </div>
                </div>
                
                <div class="plot-container">
                    <div class="plot-controls">
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-icon" onclick="downloadPlot('upload-plot')" title="Download as PNG">
                                üì• Download
                            </button>
                            <button class="btn-icon" onclick="resetZoom('upload-plot')" title="Reset View">
                                üîÑ Reset
                            </button>
                        </div>
                        <div class="plot-info">
                            <span class="info-badge" title="Click and drag to zoom">üîç Zoom</span>
                            <span class="info-badge" title="Double-click to reset">‚Ü∫ Reset</span>
                        </div>
                    </div>
                    <div id="upload-plot"></div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: AI Analysis -->
        <div id="ai-analysis" class="tab-content">
            <div class="info-card">
                <h3>ü§ñ AI-Powered Baseline Comparison</h3>
                <p><strong>Select Baseline Model for Comparison</strong></p>
                
                <div class="control-section" style="margin: 20px 0; background: white;">
                    <label for="age-group-select" style="font-weight: bold; display: block; margin-bottom: 10px;">
                        üë§ Select Baseline Population:
                    </label>
                    <select id="age-group-select" style="width: 100%; padding: 10px; font-size: 1em; border: 2px solid #667eea; border-radius: 5px;">
                        <option value="children">Children with ASD (Ages 3-12) - Cilia et al. (2023)</option>
                        <option value="adult">Adults with ASD - Trained on 24 participants</option>
                        <option value="neurotypical">Neurotypical (Healthy Controls) - ETDB v1.0</option>
                    </select>
                </div>
                
                <div id="children-info" class="age-info-section">
                    <p><strong>üßí Children ASD Baseline Model (Ages 3-12)</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> 23 children with ASD diagnosis (3-12 years)</li>
                            <li><strong>Task:</strong> Free viewing of social scenes and interactive stimuli</li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Sampling rate: Variable (250-500 Hz recommended)</li>
                                    <li>Calibration: 5-point or 9-point procedure</li>
                                    <li>Session duration: ~10-15 minutes per participant</li>
                                </ul>
                            </li>
                            <li><strong>Data Format:</strong> CSV with columns: timestamp, x, y, fixation_duration, pupil_size</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (Unsupervised Learning)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28</li>
                            <li><strong>Features Extracted:</strong> 28 statistical features including:
                                <ul>
                                    <li>Spatial: mean, std, min, max positions (X, Y)</li>
                                    <li>Temporal: fixation duration, saccade velocity/amplitude</li>
                                    <li>Behavioral: spatial coverage, entropy, center bias, scan path length</li>
                                </ul>
                            </li>
                            <li><strong>Training:</strong> 80/20 train-val split, Adam optimizer, MSE loss</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.4069</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Use any eye-tracker with ‚â•250 Hz sampling rate</li>
                            <li>Perform 5-point or 9-point calibration</li>
                            <li>Record free viewing or social scene tasks (10-15 min)</li>
                            <li>Export as CSV with: timestamp, x, y coordinates</li>
                            <li>Coordinates can be raw pixels or normalized</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìö Research:</strong> <a href="https://www.researchgate.net/publication/369708398" target="_blank">Cilia et al. (2023)</a> | 
                    <strong>üìä Dataset:</strong> <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">Kaggle</a></p>
                </div>
                
                <div id="adult-info" class="age-info-section" style="display: none;">
                    <p><strong>üë® Adult ASD Baseline Model</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> 24 adults with ASD diagnosis</li>
                            <li><strong>Task:</strong> 36 trials per participant (864 total trials)</li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Trial duration: ~14,000 time samples per trial</li>
                                    <li>Sampling rate: Estimated 250-500 Hz</li>
                                    <li>Viewing distance: Controlled laboratory setting</li>
                                </ul>
                            </li>
                            <li><strong>Data Format:</strong> MATLAB .mat file ‚Üí converted to CSV format</li>
                            <li><strong>Original Source:</strong> RawEyetrackingASD.mat dataset</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (same as children model)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28 (8,020 parameters)</li>
                            <li><strong>Features:</strong> Identical 28 features as children model for consistency</li>
                            <li><strong>Training:</strong> 80/20 split, Adam optimizer, early stopping (patience=15)</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.6065</li>
                            <li><strong>Note:</strong> Higher MAE reflects greater variability in adult ASD gaze patterns</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Recruit adult participants (18+ years) with ASD diagnosis</li>
                            <li>Use eye-tracker with ‚â•250 Hz sampling (Tobii, EyeLink, etc.)</li>
                            <li>Multiple trials per participant (30-40 recommended)</li>
                            <li>Record during natural viewing or cognitive tasks</li>
                            <li>Export with timestamp, x, y, and optional pupil diameter</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìä Dataset:</strong> <a href="https://www.kaggle.com/datasets/haocai1/raweyetrackingasd" target="_blank">Kaggle - RawEyetrackingASD</a></p>
                </div>
                
                <div id="neurotypical-info" class="age-info-section" style="display: none;">
                    <p><strong>üòä Neurotypical Baseline Model (Healthy Controls)</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> Healthy individuals (ages 7-80 years)</li>
                            <li><strong>Datasets Used:</strong> 5 experiments from ETDB v1.0
                                <ul>
                                    <li>Baseline: Free viewing of complex images</li>
                                    <li>Age study: Comparing different age groups</li>
                                    <li>Memory I & II: Visual memory tasks</li>
                                    <li>Patch: Texture pattern viewing</li>
                                </ul>
                            </li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Eye-tracker: Various (see ETDB documentation)</li>
                                    <li>Sampling rates: 250-500 Hz</li>
                                    <li>Display: 1024√ó768 to 1920√ó1080 resolution</li>
                                    <li>Viewing distance: 60-70 cm typical</li>
                                </ul>
                            </li>
                            <li><strong>Total Trials:</strong> 836 trials across multiple experiments</li>
                            <li><strong>Data Format:</strong> HDF5 with keys: x, y, trial, SUBJECTINDEX, fixation markers</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (identical to ASD models)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28</li>
                            <li><strong>Features:</strong> Same 28 features (spatial, temporal, behavioral)</li>
                            <li><strong>Training:</strong> 80/20 split, 100 epochs, early stopping</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.3478 (best performance)</li>
                            <li><strong>Interpretation:</strong> Lower MAE indicates more consistent, predictable gaze patterns in neurotypical population</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Screen healthy participants (no neurological conditions)</li>
                            <li>Use research-grade eye-tracker (‚â•250 Hz)</li>
                            <li>Tasks: Free viewing of complex scenes (natural images, faces, etc.)</li>
                            <li>Include diverse age range for robust baseline</li>
                            <li>Standardize viewing distance (~60-70 cm) and display size</li>
                            <li>Multiple trials per participant (10-30 recommended)</li>
                            <li>Export: timestamp, x, y in screen coordinates or degrees of visual angle</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìö Research:</strong> <a href="https://doi.org/10.1038/sdata.2016.126" target="_blank">Wilming et al. (2017) - Nature Scientific Data</a> | 
                    <strong>üìä Dataset:</strong> <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.9pf75" target="_blank">ETDB v1.0 - Dryad</a></p>
                </div>
                
                <p style="margin-top: 15px;"><em>‚ö†Ô∏è Important: Select appropriate baseline for meaningful comparison. Neurotypical baseline provides reference for healthy population, while ASD baselines are age-specific.</em></p>
            </div>
            
            <div id="ai-loading" style="display: none;">
                <div class="spinner"></div>
                <div class="loading-text">Loading AI model...</div>
            </div>
            
            <div id="ai-status" class="status-message"></div>
            
            <div id="ai-results" style="display: none;">
                <div class="results-container">
                    <!-- Enhanced Score Card -->
                    <div class="result-card score-card">
                        <h4>üéØ Similarity Score</h4>
                        <div class="score-gauge">
                            <svg viewBox="0 0 200 200">
                                <circle cx="100" cy="100" r="90" fill="none" stroke="#e9ecef" stroke-width="20"/>
                                <circle 
                                    cx="100" cy="100" r="90" 
                                    fill="none" 
                                    stroke="url(#scoreGradient)" 
                                    stroke-width="20"
                                    stroke-dasharray="565"
                                    stroke-dashoffset="565"
                                    id="score-circle"
                                    transform="rotate(-90 100 100)"
                                    style="transition: stroke-dashoffset 1s ease"
                                />
                                <defs>
                                    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#667eea"/>
                                        <stop offset="100%" stop-color="#764ba2"/>
                                    </linearGradient>
                                </defs>
                                <text x="100" y="100" text-anchor="middle" dy="0.3em" class="score-text" id="similarity-score">--</text>
                            </svg>
                        </div>
                        <div class="interpretation-enhanced">
                            <div class="interpretation-icon" id="interpretation-icon">üìä</div>
                            <p class="interpretation-text" id="interpretation"></p>
                            <div class="confidence-bar">
                                <div class="confidence-fill" id="confidence-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Metrics Grid -->
                    <div class="result-card">
                        <h4>üìä Analysis Metrics</h4>
                        <div class="metrics-grid" id="detailed-metrics"></div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üî¨ Feature Analysis</h4>
                        <div id="feature-analysis"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-section" style="margin-top: 20px;">
                <p><strong>Note:</strong> Upload CSV data first in the "Upload CSV" tab, then click "Compare to AI Baseline"</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2024 Eye-Tracking Visualizer | Open Source Project</p>
            
            <p style="margin-top: 15px;"><strong>üìö Research Citations & Datasets:</strong></p>
            
            <div class="citation-cards">
                <div class="citation-card">
                    <h4>üë∂ Children ASD Baseline (Ages 3-12)</h4>
                    <p>
                        Cilia, N. D., Boccignone, G., Campolese, M., De Stefano, C., & Scotto di Freca, A. (2023).<br>
                        <em>Eyes Tell All: Gaze Tracking, Recognition & Understanding for Assisting Children with Autism Spectrum Disorder.</em>
                    </p>
                    <p>
                        <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">üìä Dataset on Kaggle</a> | 
                        <a href="https://www.researchgate.net/publication/369708398_Eye-tracking_Dataset_to_Support_the_Research_on_Autism_Spectrum_Disorder" target="_blank">üìÑ Research Paper</a>
                    </p>
                </div>
                
                <div class="citation-card">
                    <h4>üë® Adult ASD Baseline</h4>
                    <p>
                        Trained on 24 adult participants with ASD (36 trials each).<br>
                        Source: RawEyetrackingASD.mat<br>
                        Validation MAE: 0.6065 | Architecture: 28‚Üí32‚Üí48‚Üí24‚Üí48‚Üí32‚Üí28
                    </p>
                    <p>
                        <a href="https://www.kaggle.com/datasets/haocai1/raweyetrackingasd" target="_blank">üìä Dataset on Kaggle</a>
                    </p>
                </div>
                
                <div class="citation-card">
                    <h4>‚úÖ Neurotypical Baseline (Healthy Controls)</h4>
                    <p>
                        Wilming, N., Onat, S., Ossand√≥n, J. P., et al. (2017).<br>
                        <em>An extensive dataset of eye movements during viewing of complex images.</em><br>
                        Scientific Data, 4, 160126.
                    </p>
                    <p>
                        836 trials from diverse age range (7-80 years) | Validation MAE: 0.3478
                    </p>
                    <p>
                        <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.9pf75" target="_blank">üìä ETDB v1.0 Dataset</a> | 
                        <a href="https://doi.org/10.1038/sdata.2016.126" target="_blank">üìÑ Nature Paper</a>
                    </p>
                </div>
            </div>
            
            <p style="margin-top: 20px; text-align: center;">
                <a href="https://github.com/rogerjs93/eyetrackingvisualiser" target="_blank" style="font-size: 1.1em;">üìÇ View Source Code on GitHub</a>
            </p>
        </div>
    </div>
    
    <script>
        // Global variables - SEPARATED by data source
        let syntheticData = [];  // For generated synthetic data
        let uploadedRawData = [];  // For uploaded CSV raw coordinates
        let uploadedNormalizedData = [];  // For uploaded CSV normalized coordinates
        let baselineModel = null;
        let currentAgeGroup = 'children'; // Default to children model
        let coordinateMode = 'raw'; // Default to raw mode
        
        // Handle age group selection
        function handleAgeGroupChange() {
            const ageSelect = document.getElementById('age-group-select');
            currentAgeGroup = ageSelect.value;
            
            // Show/hide appropriate info sections
            document.getElementById('children-info').style.display = 
                currentAgeGroup === 'children' ? 'block' : 'none';
            document.getElementById('adult-info').style.display = 
                currentAgeGroup === 'adult' ? 'block' : 'none';
            document.getElementById('neurotypical-info').style.display = 
                currentAgeGroup === 'neurotypical' ? 'block' : 'none';
            
            // Reload model if needed
            loadAgeSpecificModel();
        }
        
        // Load the appropriate model based on age group
        async function loadAgeSpecificModel() {
            try {
                const modelNames = {
                    'children': 'Children ASD',
                    'adult': 'Adult ASD',
                    'neurotypical': 'Neurotypical'
                };
                showStatus('ai-status', `Loading ${modelNames[currentAgeGroup]} baseline model...`, 'info');
                document.getElementById('ai-loading').style.display = 'block';
                
                baselineModel = new BaselineModelWeb();
                
                // Set model path based on age group
                if (currentAgeGroup === 'adult') {
                    baselineModel.modelPath = 'models/baseline_adult_asd_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_adult_asd_tfjs/scaler.json';
                    baselineModel.threshold = 0.6065; // Adult threshold
                } else if (currentAgeGroup === 'neurotypical') {
                    baselineModel.modelPath = 'models/baseline_neurotypical_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_neurotypical_tfjs/scaler.json';
                    baselineModel.threshold = 0.3478; // Neurotypical threshold
                } else {
                    baselineModel.modelPath = 'models/baseline_children_asd_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_children_asd_tfjs/scaler.json';
                    baselineModel.threshold = 0.4069; // Children threshold
                }
                
                await baselineModel.loadModel();
                
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', `‚úÖ ${modelNames[currentAgeGroup]} baseline model loaded successfully!`, 'success');
                
                console.log(`‚úÖ ${currentAgeGroup} baseline model loaded`);
            } catch (error) {
                console.error('‚ùå Failed to load model:', error);
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', '‚ö†Ô∏è AI model failed to load. CSV upload still works for visualization.', 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Eye-Tracking Visualizer Loaded');
            
            // Setup age group selector
            const ageSelect = document.getElementById('age-group-select');
            ageSelect.addEventListener('change', handleAgeGroupChange);
            
            // Try to pre-load the AI model (children by default)
            await loadAgeSpecificModel();
            
            // Setup file upload drag & drop
            const uploadArea = document.getElementById('file-upload-area');
            
            uploadArea.addEventListener('click', () => {
                document.getElementById('csv-file-input').click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        });
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Set button active
            event.target.closest('.tab-button').classList.add('active');
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Generate synthetic data - INDEPENDENT function
        function generateData() {
            const numPoints = parseInt(document.getElementById('num-points').value);
            const patternType = document.getElementById('pattern-type').value;
            const plotType = document.getElementById('plot-type').value;
            
            // Generate and store in synthetic data variable
            syntheticData = generateSyntheticData(numPoints, patternType);
            
            console.log(`‚úÖ Generated ${syntheticData.length} synthetic data points`);
            
            // Visualize in quick-plot container ONLY
            visualizePlot('quick-plot', syntheticData, plotType, 'Synthetic Eye-Tracking Data');
        }
        
        // Generate synthetic eye-tracking data
        function generateSyntheticData(n, pattern) {
            const data = [];
            let centerX = 50, centerY = 50;
            
            for (let i = 0; i < n; i++) {
                let x, y;
                
                switch(pattern) {
                    case 'focused':
                        x = centerX + (Math.random() - 0.5) * 20;
                        y = centerY + (Math.random() - 0.5) * 20;
                        break;
                    case 'scanning':
                        x = (i / n) * 80 + 10;
                        y = 30 + Math.sin(i * 0.3) * 20;
                        break;
                    case 'reading':
                        const line = Math.floor(i / (n/5));
                        x = 10 + (i % (n/5)) / (n/5) * 80;
                        y = 20 + line * 15;
                        break;
                    default: // random
                        x = Math.random() * 100;
                        y = Math.random() * 100;
                }
                
                data.push({
                    timestamp: i * 100,
                    x: Math.max(0, Math.min(100, x)),
                    y: Math.max(0, Math.min(100, y)),
                    fixation_duration: 150 + Math.random() * 200,
                    pupil_size: 3 + Math.random() * 2
                });
            }
            
            return data;
        }
        
        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            handleFile(file);
        }
        
        function handleFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('upload-status', '‚ùå Please select a CSV file', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const parsedData = parseCSV(csv);
                    
                    // Early sampling if data is huge (before any processing)
                    const MAX_POINTS = 5000;
                    let displayCount = parsedData.length;
                    if (parsedData.length > MAX_POINTS) {
                        displayCount = MAX_POINTS;
                        showStatus('upload-status', `‚úÖ Loaded ${parsedData.length} points (will visualize ${MAX_POINTS} sampled points for performance)`, 'success');
                    } else {
                        showStatus('upload-status', `‚úÖ Successfully loaded ${parsedData.length} data points`, 'success');
                    }
                    
                    // Show results section
                    document.getElementById('upload-results').style.display = 'block';
                    
                    // Display summary using current coordinate mode
                    const dataToDisplay = coordinateMode === 'raw' ? uploadedRawData : uploadedNormalizedData;
                    displayDataSummary(dataToDisplay);
                    
                    // Auto-visualize
                    visualizeUploadedData();
                    
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    showStatus('upload-status', `‚ùå Error parsing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Parse CSV - STORES in uploaded data variables
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length === 0) {
                throw new Error('CSV file is empty');
            }
            
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            console.log('üìã CSV Headers found:', headers.length, 'columns');
            console.log('üìã First 10 headers:', headers.slice(0, 10));
            
            // Detect column indices - more sophisticated matching for eye-tracking data
            // Look for patterns: x, gaze_x, pupil x, x [px], etc.
            let xIndex = -1;
            let yIndex = -1;
            
            // Priority 1: Exact matches
            xIndex = headers.findIndex(h => h === 'x' || h === 'gaze_x' || h === 'x_pos');
            yIndex = headers.findIndex(h => h === 'y' || h === 'gaze_y' || h === 'y_pos');
            
            // Priority 2: Pupil position columns (common in eye-trackers)
            if (xIndex === -1) {
                xIndex = headers.findIndex(h => h.includes('pupil') && h.includes('x') && h.includes('[px]'));
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex(h => h.includes('pupil') && h.includes('y') && h.includes('[px]'));
            }
            
            // Priority 3: Any column with coordinate-like names
            if (xIndex === -1) {
                xIndex = headers.findIndex(h => 
                    (h.includes('x') && h.includes('pos')) ||
                    (h.includes('x') && h.includes('coord')) ||
                    h.endsWith('_x') || h.endsWith(' x')
                );
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex(h => 
                    (h.includes('y') && h.includes('pos')) ||
                    (h.includes('y') && h.includes('coord')) ||
                    h.endsWith('_y') || h.endsWith(' y')
                );
            }
            
            // Priority 4: Fallback - first column with x or y (but avoid index columns)
            if (xIndex === -1) {
                xIndex = headers.findIndex((h, i) => i > 2 && h.includes('x'));
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex((h, i) => i > 2 && h.includes('y'));
            }
            
            if (xIndex === -1 || yIndex === -1) {
                console.error('‚ùå Available headers:', headers);
                throw new Error(`Missing coordinate columns. Please ensure CSV has x and y coordinate columns.`);
            }
            
            console.log(`‚úÖ Using columns: X="${lines[0].split(',')[xIndex].trim()}" (index ${xIndex}), Y="${lines[0].split(',')[yIndex].trim()}" (index ${yIndex})`);
            
            const parsedData = [];
            let skippedRows = 0;
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // Skip empty lines
                
                const values = lines[i].split(',');
                
                // Debug first row
                if (i === 1) {
                    console.log('üîç First data row values:', values);
                    console.log(`üîç Value at xIndex ${xIndex}:`, values[xIndex]);
                    console.log(`üîç Value at yIndex ${yIndex}:`, values[yIndex]);
                }
                
                // Parse coordinates from detected columns
                const x = parseFloat(values[xIndex]);
                const y = parseFloat(values[yIndex]);
                
                // Skip invalid points
                if (isNaN(x) || isNaN(y)) {
                    skippedRows++;
                    continue;
                }
                
                const point = {
                    timestamp: parseFloat(values[headers.indexOf('timestamp')] || values[headers.indexOf('time')] || i * 100),
                    x: x,
                    y: y,
                    fixation_duration: parseFloat(values[headers.indexOf('fixation_duration')] || values[headers.indexOf('duration')] || 200),
                    pupil_size: parseFloat(values[headers.indexOf('pupil_size')] || values[headers.indexOf('pupil')] || 3.5)
                };
                
                parsedData.push(point);
            }
            
            if (skippedRows > 0) {
                console.log(`‚ö†Ô∏è Skipped ${skippedRows} invalid rows`);
            }
            
            if (parsedData.length === 0) {
                throw new Error('No valid data points found in CSV');
            }
            
            // Calculate statistics before storing
            const xValues = parsedData.map(d => d.x);
            const yValues = parsedData.map(d => d.y);
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            console.log(`‚úÖ Parsed ${parsedData.length} data points from CSV`);
            console.log(`üìä Raw coordinate ranges: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}] (range: ${xRange.toFixed(2)}), Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}] (range: ${yRange.toFixed(2)})`);
            
            // Check for suspicious data patterns
            if (xRange < 10 && yRange < 10) {
                console.warn('‚ö†Ô∏è WARNING: Very small coordinate range detected. Data might be normalized or in different units.');
            }
            
            // Count zeros or negative values
            const zeroPoints = parsedData.filter(d => d.x === 0 && d.y === 0).length;
            const negativePoints = parsedData.filter(d => d.x < 0 || d.y < 0).length;
            if (zeroPoints > 0) {
                console.warn(`‚ö†Ô∏è Found ${zeroPoints} points at (0,0) - these might be invalid tracking points`);
            }
            if (negativePoints > 0) {
                console.warn(`‚ö†Ô∏è Found ${negativePoints} points with negative coordinates`);
            }
            
            // Store in UPLOADED data variables (not synthetic)
            uploadedRawData = parsedData;
            uploadedNormalizedData = normalizeCoordinates(parsedData);
            
            // Return raw by default
            return uploadedRawData;
        }
        
        // Normalize coordinates to 0-100 range
        function normalizeCoordinates(data) {
            if (data.length === 0) return data;
            
            // Find min/max for x and y
            const xValues = data.map(d => d.x);
            const yValues = data.map(d => d.y);
            
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            console.log(`üìä Original coordinate ranges: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
            
            // Normalize to 0-100
            const normalized = data.map(d => ({
                timestamp: d.timestamp,
                x: xRange > 0 ? ((d.x - xMin) / xRange) * 100 : 50,
                y: yRange > 0 ? ((d.y - yMin) / yRange) * 100 : 50,
                fixation_duration: d.fixation_duration,
                pupil_size: d.pupil_size
            }));
            
            console.log(`‚úÖ Normalized to 0-100 range`);
            
            return normalized;
        }
        
        // Update coordinate mode - ONLY affects uploaded data
        function updateCoordinateMode() {
            const mode = document.getElementById('coordinate-mode').value;
            coordinateMode = mode;
            
            if (uploadedRawData.length > 0) {
                console.log(`üîÑ Switched to ${mode} coordinates for uploaded data`);
                
                // Update summary with current mode
                const currentData = mode === 'raw' ? uploadedRawData : uploadedNormalizedData;
                displayDataSummary(currentData);
                
                // Re-visualize if plot exists
                const plotDiv = document.getElementById('upload-plot');
                if (plotDiv && plotDiv.data && plotDiv.data.length > 0) {
                    visualizeUploadedData();
                }
            }
        }
        
        // Display data summary - ONLY for uploaded data
        function displayDataSummary(data) {
            const summary = document.getElementById('data-summary');
            
            const xValues = data.map(d => d.x);
            const yValues = data.map(d => d.y);
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            
            const stats = {
                points: data.length,
                duration: ((data[data.length-1].timestamp - data[0].timestamp) / 1000).toFixed(2),
                avgX: (data.reduce((sum, d) => sum + d.x, 0) / data.length).toFixed(2),
                avgY: (data.reduce((sum, d) => sum + d.y, 0) / data.length).toFixed(2),
                xRange: `[${xMin.toFixed(1)}, ${xMax.toFixed(1)}]`,
                yRange: `[${yMin.toFixed(1)}, ${yMax.toFixed(1)}]`
            };
            
            const modeLabel = coordinateMode === 'raw' ? 
                'üéØ Raw screen coordinates (perfect for stimulus overlay)' : 
                'üìä Normalized 0-100 (for AI comparison)';
            
            summary.innerHTML = `
                <p><strong>Total Points:</strong> ${stats.points}</p>
                <p><strong>Duration:</strong> ${stats.duration} seconds</p>
                <p><strong>Average X:</strong> ${stats.avgX} (Range: ${stats.xRange})</p>
                <p><strong>Average Y:</strong> ${stats.avgY} (Range: ${stats.yRange})</p>
                <p style="color: #667eea; font-size: 0.9em; margin-top: 10px;"><em>${modeLabel}</em></p>
            `;
        }
        
        // Visualize uploaded data - ONLY uses uploaded data variables
        function visualizeUploadedData() {
            if (uploadedRawData.length === 0) {
                showStatus('upload-status', '‚ùå No data to visualize', 'error');
                return;
            }
            
            // Use the correct data based on coordinate mode
            let dataToVisualize = coordinateMode === 'raw' ? uploadedRawData : uploadedNormalizedData;
            
            // Check if all coordinates are zero (parsing issue)
            const allZeros = dataToVisualize.every(d => d.x === 0 && d.y === 0);
            if (allZeros) {
                showStatus('upload-status', '‚ö†Ô∏è Warning: All coordinates are zero. Check CSV format (expected columns: x, y or gaze_x, gaze_y)', 'error');
                console.error('‚ùå CSV parsing issue - all coordinates are 0,0');
                return;
            }
            
            // Downsample if too many points (max 5000 for smooth rendering)
            const MAX_POINTS = 5000;
            if (dataToVisualize.length > MAX_POINTS) {
                const samplingRate = Math.ceil(dataToVisualize.length / MAX_POINTS);
                const sampledData = dataToVisualize.filter((_, index) => index % samplingRate === 0);
                console.log(`‚ö†Ô∏è Downsampling: ${dataToVisualize.length} ‚Üí ${sampledData.length} points (every ${samplingRate}th point)`);
                dataToVisualize = sampledData;
                
                showStatus('upload-status', `üìä Visualizing ${sampledData.length} sampled points (from ${uploadedRawData.length} total)`, 'info');
            }
            
            const plotType = document.getElementById('upload-plot-type').value;
            
            console.log(`üìä Visualizing ${dataToVisualize.length} points in ${coordinateMode} mode`);
            
            // Show sample of data being visualized
            if (dataToVisualize.length > 0) {
                console.log('üìç Sample points:', dataToVisualize.slice(0, 5).map(d => `(${d.x.toFixed(2)}, ${d.y.toFixed(2)})`).join(', '));
            }
            
            // Visualize in upload-plot container ONLY
            visualizePlot('upload-plot', dataToVisualize, plotType, `Uploaded Data (${coordinateMode} coordinates)`);
        }
        
        // Compare to baseline - ONLY uses uploaded normalized data
        async function compareToBaseline() {
            if (uploadedRawData.length === 0) {
                showStatus('upload-status', '‚ùå No data loaded. Please upload CSV first.', 'error');
                return;
            }
            
            if (!baselineModel || !baselineModel.isModelLoaded) {
                showStatus('upload-status', '‚ùå AI model not loaded', 'error');
                return;
            }
            
            // Always use normalized data for AI comparison
            const dataForComparison = uploadedNormalizedData;
            
            if (coordinateMode === 'raw') {
                console.log('‚ö†Ô∏è AI comparison requires normalized coordinates. Automatically using normalized data.');
            }
            
            console.log(`ü§ñ Comparing ${dataForComparison.length} normalized data points to ${currentAgeGroup} baseline`);
            
            // Switch to AI Analysis tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('ai-analysis').classList.add('active');
            document.querySelectorAll('.tab-button')[2].classList.add('active');
            
            // Show loading with steps
            showLoading('AI Analysis', 'Comparing your data to baseline model...', [
                '‚è≥ Loading model...',
                '‚è≥ Extracting features...',
                '‚è≥ Computing similarity...',
                '‚è≥ Analyzing patterns...'
            ]);
            
            updateLoadingStep(1, 'active');
            document.getElementById('ai-results').style.display = 'none';
            
            try {
                updateLoadingStep(1, 'completed');
                updateLoadingStep(2, 'active');
                
                const results = await baselineModel.compareToBaseline(dataForComparison);
                
                updateLoadingStep(2, 'completed');
                updateLoadingStep(3, 'active');
                
                setTimeout(() => {
                    updateLoadingStep(3, 'completed');
                    updateLoadingStep(4, 'active');
                    
                    setTimeout(() => {
                        updateLoadingStep(4, 'completed');
                        hideLoading();
                        
                        // Display results
                        document.getElementById('ai-results').style.display = 'block';
                        
                        // Feature analysis (top deviations)
                        const featureNames = ['X Mean', 'X Std', 'X Min', 'X Max', 'Y Mean', 'Y Std', 'Y Min', 'Y Max',
                            'Fixation Duration Mean', 'Fixation Duration Std', 'Fixation Count', 'Saccade Velocity Mean',
                            'Saccade Velocity Std', 'Saccade Amplitude Mean', 'Saccade Amplitude Std', 'Pupil Size Mean',
                            'Pupil Size Std', 'Spatial Coverage', 'Fixation Dispersion', 'Scan Path Length',
                            'Gaze Entropy', 'Center Bias', 'Edge Bias', 'ROI Focus', 'V/H Ratio',
                            'Temporal Consistency', 'Attention Switches', 'Revisit Rate'];
                        
                        // Display feature analysis if available
                        let featureHTML = '';
                        if (results.zScores && results.zScores.length > 0) {
                            featureHTML = '<table style="width:100%; border-collapse: collapse;">';
                            featureHTML += '<tr><th style="text-align:left; padding: 5px; border-bottom: 1px solid #ddd;">Feature</th>';
                            featureHTML += '<th style="text-align:right; padding: 5px; border-bottom: 1px solid #ddd;">Z-Score</th></tr>';
                            
                            results.zScores.forEach((z, i) => {
                                const absZ = Math.abs(z);
                                if (absZ > 1.5) {  // Show significant deviations
                                    const color = absZ > 2 ? '#dc3545' : '#ffc107';
                                    featureHTML += `<tr style="background: ${color}22;">`;
                                    featureHTML += `<td style="padding: 5px;">${featureNames[i]}</td>`;
                                    featureHTML += `<td style="padding: 5px; text-align: right;">${z.toFixed(2)}</td>`;
                                    featureHTML += '</tr>';
                                }
                            });
                            
                            featureHTML += '</table>';
                        } else {
                            featureHTML = '<p style="padding: 10px; color: #666;">Feature analysis based on reconstruction error only.</p>';
                        }
                        
                        // Use enhanced display function
                        updateAIResultsDisplay(
                            results.similarityScore,
                            results.interpretation,
                            {
                                error: results.reconstructionError.toFixed(4),
                                points: dataForComparison.length
                            },
                            featureHTML
                        );
                        
                        showToast('success', 'Analysis Complete', `Similarity Score: ${results.similarityScore.toFixed(1)}%`);
                    }, 500);
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Error during comparison:', error);
                hideLoading();
                showToast('error', 'Analysis Failed', error.message);
            }
        }
        
        // Visualization function - optimized for large datasets
        function visualizePlot(containerId, data, plotType, title) {
            console.log(`üé® Starting visualization: ${data.length} points, type: ${plotType}`);
            
            // Clear any existing plot first
            const container = document.getElementById(containerId);
            Plotly.purge(container);
            
            const x = data.map(d => d.x);
            const y = data.map(d => d.y);
            
            const xMin = Math.min(...x);
            const xMax = Math.max(...x);
            const yMin = Math.min(...y);
            const yMax = Math.max(...y);
            
            console.log(`üìä X range: [${xMin.toFixed(2)}, ${xMax.toFixed(2)}]`);
            console.log(`üìä Y range: [${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
            
            // Check if data is valid
            if (xMin === xMax && yMin === yMax) {
                console.error('‚ùå All points have the same coordinates!');
                document.getElementById(containerId).innerHTML = 
                    `<div style="padding: 20px; color: red;">
                        <h3>‚ö†Ô∏è Invalid Data</h3>
                        <p>All data points have the same coordinates (${xMin.toFixed(2)}, ${yMin.toFixed(2)})</p>
                        <p>Please check your CSV file format and column names.</p>
                    </div>`;
                return;
            }
            
            let plotData;
            
            // Common layout settings
            const layout = {
                title: title,
                xaxis: { 
                    title: 'X Position',
                    autorange: true
                },
                yaxis: { 
                    title: 'Y Position',
                    autorange: 'reversed'  // Eye-tracking typically has Y increasing downward
                },
                height: 600,
                hovermode: 'closest',
                showlegend: false
            };
            
            switch(plotType) {
                case 'scatter':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        marker: {
                            size: 5,
                            color: data.map((d, i) => i),
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {
                                title: 'Sequence'
                            }
                        }
                    }];
                    break;
                    
                case 'heatmap':
                    // Use histogram2d for large datasets
                    plotData = [{
                        x: x,
                        y: y,
                        type: 'histogram2d',
                        colorscale: 'Hot',
                        reversescale: true,
                        nbinsx: 50,
                        nbinsy: 50,
                        colorbar: {
                            title: 'Fixation<br>Density'
                        }
                    }];
                    layout.title = title + ' - Fixation Density';
                    break;
                    
                case 'path':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'lines+markers',
                        type: 'scatter',
                        line: { 
                            color: '#667eea', 
                            width: 1 
                        },
                        marker: { 
                            size: 3, 
                            color: '#764ba2' 
                        }
                    }];
                    layout.title = title + ' - Scan Path';
                    break;
                    
                case 'histogram':
                    // Show distribution of X and Y separately
                    plotData = [
                        {
                            x: x,
                            type: 'histogram',
                            name: 'X Distribution',
                            marker: { color: '#667eea' },
                            opacity: 0.7,
                            nbinsx: 30
                        },
                        {
                            x: y,
                            type: 'histogram',
                            name: 'Y Distribution',
                            marker: { color: '#764ba2' },
                            opacity: 0.7,
                            nbinsx: 30
                        }
                    ];
                    layout.xaxis.title = 'Position (pixels)';
                    layout.yaxis.title = 'Frequency';
                    layout.yaxis.autorange = true; // Don't reverse for histogram
                    layout.barmode = 'overlay';
                    layout.showlegend = true;
                    layout.title = title + ' - Position Distribution';
                    break;
                    
                case 'density':
                    // Density contour plot
                    plotData = [{
                        x: x,
                        y: y,
                        type: 'histogram2dcontour',
                        colorscale: 'Viridis',
                        contours: {
                            showlabels: true,
                            labelfont: {
                                family: 'Raleway',
                                size: 12,
                                color: 'white'
                            }
                        },
                        colorbar: {
                            title: 'Density'
                        }
                    }];
                    layout.title = title + ' - Density Contour';
                    break;
                    
                case '3d':
                    // 3D trajectory with time as Z-axis
                    const timestamps = data.map(d => d.timestamp);
                    plotData = [{
                        x: x,
                        y: y,
                        z: timestamps,
                        mode: 'markers+lines',
                        type: 'scatter3d',
                        marker: {
                            size: 3,
                            color: timestamps,
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {
                                title: 'Time'
                            }
                        },
                        line: {
                            color: '#667eea',
                            width: 2
                        }
                    }];
                    layout.scene = {
                        xaxis: { title: 'X Position' },
                        yaxis: { title: 'Y Position' },
                        zaxis: { title: 'Time (ms)' }
                    };
                    layout.title = title + ' - 3D Trajectory';
                    delete layout.xaxis;
                    delete layout.yaxis;
                    break;
                    
                case 'temporal':
                    // X and Y positions over time
                    const times = data.map(d => d.timestamp);
                    plotData = [
                        {
                            x: times,
                            y: x,
                            mode: 'lines',
                            name: 'X Position',
                            line: { color: '#667eea', width: 2 }
                        },
                        {
                            x: times,
                            y: y,
                            mode: 'lines',
                            name: 'Y Position',
                            line: { color: '#764ba2', width: 2 }
                        }
                    ];
                    layout.xaxis.title = 'Time (ms)';
                    layout.yaxis.title = 'Position (pixels)';
                    layout.yaxis.autorange = true; // Don't reverse for temporal
                    layout.showlegend = true;
                    layout.title = title + ' - Temporal Analysis';
                    break;
                    
                default:
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        marker: { 
                            size: 5,
                            color: '#667eea'
                        }
                    }];
            }
            
            // Use responsive layout with proper config
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };
            
            console.log('üé® Rendering plot with Plotly...');
            console.log(`üìä Plot data: ${plotData[0].x.length} x-values, ${plotData[0].y.length} y-values`);
            
            // Render with error handling
            Plotly.newPlot(containerId, plotData, layout, config)
                .then(() => {
                    console.log('‚úÖ Plot rendered successfully');
                })
                .catch(error => {
                    console.error('‚ùå Plotly rendering error:', error);
                    document.getElementById(containerId).innerHTML = 
                        `<div style="padding: 20px; color: red;">
                            <h3>Visualization Error</h3>
                            <p>${error.message}</p>
                            <p>Try reducing the data size or selecting a different plot type.</p>
                        </div>`;
                });
        }
        
        // Toast Notification System
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úó',
                warning: '‚ö†',
                info: '‚Ñπ'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    ${message ? `<div class="toast-message">${message}</div>` : ''}
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
        
        // Loading Overlay Control
        function showLoading(title, message, steps = []) {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-title').textContent = title;
            document.getElementById('loading-message').textContent = message;
            
            const stepsContainer = document.getElementById('loading-steps');
            if (steps.length > 0) {
                stepsContainer.innerHTML = steps.map((step, i) => 
                    `<div class="step" id="step-${i + 1}">${step}</div>`
                ).join('');
            }
            
            overlay.style.display = 'flex';
        }
        
        function updateLoadingStep(stepNumber, status = 'active') {
            const step = document.getElementById(`step-${stepNumber}`);
            if (step) {
                step.className = `step ${status}`;
                if (status === 'completed') {
                    step.textContent = '‚úì ' + step.textContent.replace('‚è≥ ', '');
                }
            }
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        // File Upload Progress
        function showUploadProgress(percent) {
            const progress = document.getElementById('upload-progress');
            const fill = document.getElementById('progress-fill');
            const percentText = document.getElementById('progress-percent');
            
            progress.style.display = 'block';
            fill.style.width = percent + '%';
            percentText.textContent = percent + '%';
        }
        
        function hideUploadProgress() {
            document.getElementById('upload-progress').style.display = 'none';
        }
        
        function showFileInfo(filename, size, rows) {
            const fileInfo = document.getElementById('file-info');
            document.getElementById('filename').textContent = filename;
            document.getElementById('filesize').textContent = (size / 1024).toFixed(2) + ' KB';
            document.getElementById('filerows').textContent = rows;
            fileInfo.style.display = 'block';
        }
        
        // Plot Download Function
        function downloadPlot(plotId) {
            Plotly.downloadImage(document.getElementById(plotId), {
                format: 'png',
                width: 1200,
                height: 800,
                filename: `eye-tracking-${plotId}-${Date.now()}`
            });
            showToast('success', 'Download Started', 'Your plot is being downloaded');
        }
        
        // Reset Zoom Function
        function resetZoom(plotId) {
            Plotly.relayout(document.getElementById(plotId), {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
            showToast('info', 'View Reset', 'Zoom has been reset to default');
        }
        
        // Form Validation
        function validateNumberInput(inputId, min, max) {
            const input = document.getElementById(inputId);
            const value = parseInt(input.value);
            const errorElement = document.getElementById(inputId + '-error');
            
            if (isNaN(value) || value < min || value > max) {
                input.classList.add('error');
                if (errorElement) errorElement.style.display = 'block';
                return false;
            } else {
                input.classList.remove('error');
                input.classList.add('validated');
                if (errorElement) errorElement.style.display = 'none';
                return true;
            }
        }
        
        // Enhanced Generate Data with validation and feedback
        const originalGenerateData = generateData;
        generateData = function() {
            // Validate inputs
            if (!validateNumberInput('num-points', 10, 1000)) {
                showToast('error', 'Invalid Input', 'Number of points must be between 10 and 1000');
                return;
            }
            
            // Show loading
            showLoading('Generating Data', 'Creating synthetic eye-tracking patterns...', [
                '‚è≥ Initializing generator...',
                '‚è≥ Generating data points...',
                '‚è≥ Applying pattern...',
                '‚è≥ Rendering visualization...'
            ]);
            
            updateLoadingStep(1, 'active');
            setTimeout(() => {
                updateLoadingStep(1, 'completed');
                updateLoadingStep(2, 'active');
                
                setTimeout(() => {
                    updateLoadingStep(2, 'completed');
                    updateLoadingStep(3, 'active');
                    
                    setTimeout(() => {
                        updateLoadingStep(3, 'completed');
                        updateLoadingStep(4, 'active');
                        
                        // Call original function
                        originalGenerateData();
                        
                        setTimeout(() => {
                            updateLoadingStep(4, 'completed');
                            hideLoading();
                            
                            // Hide empty state, show plot
                            document.getElementById('quick-plot-empty').style.display = 'none';
                            document.getElementById('quick-plot-container').style.display = 'block';
                            
                            showToast('success', 'Data Generated', `Created ${document.getElementById('num-points').value} data points`);
                        }, 500);
                    }, 300);
                }, 300);
            }, 300);
        };
        
        // Enhanced File Upload Handler
        const originalHandleFileSelect = handleFileSelect;
        handleFileSelect = async function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show file info
            showFileInfo(file.name, file.size, 'Processing...');
            
            // Simulate progress
            showUploadProgress(0);
            const progressInterval = setInterval(() => {
                const currentProgress = parseInt(document.getElementById('progress-percent').textContent);
                if (currentProgress < 90) {
                    showUploadProgress(currentProgress + 10);
                }
            }, 100);
            
            try {
                // Call original handler
                await originalHandleFileSelect(event);
                
                clearInterval(progressInterval);
                showUploadProgress(100);
                
                setTimeout(() => {
                    hideUploadProgress();
                    // Hide empty state
                    document.getElementById('upload-empty').style.display = 'none';
                    showToast('success', 'File Uploaded', `Successfully loaded ${file.name}`);
                }, 500);
                
            } catch (error) {
                clearInterval(progressInterval);
                hideUploadProgress();
                showToast('error', 'Upload Failed', error.message);
            }
        };
        
        // Update AI Results Display with Enhanced Visualization
        function updateAIResultsDisplay(similarity, interpretation, metrics, features) {
            // Update score gauge
            const scoreCircle = document.getElementById('score-circle');
            const scoreText = document.getElementById('similarity-score');
            const confidenceFill = document.getElementById('confidence-fill');
            const interpretationIcon = document.getElementById('interpretation-icon');
            
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (similarity / 100 * circumference);
            
            scoreCircle.style.strokeDashoffset = offset;
            scoreText.textContent = similarity.toFixed(1) + '%';
            confidenceFill.style.width = similarity + '%';
            
            // Update icon based on score
            if (similarity >= 80) {
                interpretationIcon.textContent = '‚úì';
            } else if (similarity >= 60) {
                interpretationIcon.textContent = '‚ö†';
            } else {
                interpretationIcon.textContent = '‚úó';
            }
            
            // Update interpretation
            document.getElementById('interpretation').textContent = interpretation;
            
            // Update metrics with icons
            const metricsContainer = document.getElementById('detailed-metrics');
            metricsContainer.innerHTML = `
                <div class="metric-item">
                    <span class="metric-icon">üìâ</span>
                    <div>
                        <div class="metric-label">Reconstruction Error</div>
                        <div class="metric-value">${metrics.error || '--'}</div>
                    </div>
                </div>
                <div class="metric-item">
                    <span class="metric-icon">üìç</span>
                    <div>
                        <div class="metric-label">Data Points Analyzed</div>
                        <div class="metric-value">${metrics.points || '--'}</div>
                    </div>
                </div>
                <div class="metric-item">
                    <span class="metric-icon">üß†</span>
                    <div>
                        <div class="metric-label">Features Extracted</div>
                        <div class="metric-value">28</div>
                    </div>
                </div>
            `;
            
            // Update feature analysis
            document.getElementById('feature-analysis').innerHTML = features;
        }
        
        // Initialize animations on page load
        window.addEventListener('load', () => {
            // Create circular text animation
            const container = document.getElementById('circularTextContainer');
            if (container) {
                const text = 'Eye-Tracking Data Visualizer';
                const circularDiv = document.createElement('div');
                circularDiv.className = 'circular-text';
                
                const chars = text.split('');
                const angleStep = 360 / chars.length;
                
                chars.forEach((char, i) => {
                    const span = document.createElement('span');
                    span.textContent = char;
                    span.style.transform = `rotate(${i * angleStep}deg)`;
                    span.style.animationDelay = `${i * 0.03}s`;
                    circularDiv.appendChild(span);
                });
                
                container.appendChild(circularDiv);
            }
            
            // Stagger control section animations
            document.querySelectorAll('.control-section').forEach((section, i) => {
                section.style.animationDelay = `${0.2 + (i * 0.15)}s`;
            });
            
            // Stagger info card animations
            document.querySelectorAll('.info-card').forEach((card, i) => {
                card.style.animationDelay = `${0.3 + (i * 0.1)}s`;
            });
            
            // Add input validation listeners
            const numPointsInput = document.getElementById('num-points');
            if (numPointsInput) {
                numPointsInput.addEventListener('blur', () => {
                    validateNumberInput('num-points', 10, 1000);
                });
            }
        });
    </script>
</body>
</html>
