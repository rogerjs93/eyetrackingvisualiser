<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking Data Visualizer - AI-Powered Analysis</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="baseline_model_web.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-top: 10px;
        }
        
        .header .beta-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-icon {
            font-size: 1.3em;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Info Cards */
        .info-card {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        
        .info-card ul {
            margin-left: 20px;
            color: #495057;
        }
        
        .info-card li {
            margin: 5px 0;
        }
        
        /* Controls */
        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .control-item select,
        .control-item input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* File Upload */
        .file-upload {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload.drag-over {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        /* Results Display */
        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        .interpretation {
            text-align: center;
            font-size: 1.2em;
            color: #495057;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
        }
        
        /* Plots */
        .plot-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            color: #6c757d;
            margin-top: 10px;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        /* Footer */
        .footer {
            background: #343a40;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* Age Info Sections */
        .age-info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .age-info-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .age-info-section li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-button {
                font-size: 0.9em;
                padding: 15px 10px;
            }
            
            .tab-icon {
                display: none;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üß† Eye-Tracking Data Visualizer</h1>
            <p>AI-Powered Analysis with Age-Specific ASD Baselines</p>
            <div class="beta-badge">‚ú® TensorFlow.js AI Features</div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('quick-start')">
                <span class="tab-icon">‚ö°</span>
                <span>Quick Start</span>
            </button>
            <button class="tab-button" onclick="switchTab('upload-data')">
                <span class="tab-icon">üì§</span>
                <span>Upload CSV</span>
            </button>
            <button class="tab-button" onclick="switchTab('ai-analysis')">
                <span class="tab-icon">ü§ñ</span>
                <span>AI Analysis</span>
            </button>
        </div>
        
        <!-- Tab 1: Quick Start (Synthetic Data) -->
        <div id="quick-start" class="tab-content active">
            <div class="info-card">
                <h3>‚ú® Quick Start with Synthetic Data</h3>
                <ul>
                    <li>Generate realistic eye-tracking patterns instantly</li>
                    <li>Explore different visualization types</li>
                    <li>Perfect for testing and demonstrations</li>
                </ul>
            </div>
            
            <div class="control-section">
                <h3>Visualization Settings</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="plot-type">Plot Type:</label>
                        <select id="plot-type">
                            <option value="scatter">Scatter Plot</option>
                            <option value="heatmap">Heatmap</option>
                            <option value="path">Scan Path</option>
                            <option value="histogram">Histogram</option>
                            <option value="density">Density Contour</option>
                            <option value="3d">3D Trajectory</option>
                            <option value="temporal">Temporal Analysis</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label for="num-points">Number of Points:</label>
                        <input type="number" id="num-points" value="100" min="10" max="1000">
                    </div>
                    
                    <div class="control-item">
                        <label for="pattern-type">Pattern Type:</label>
                        <select id="pattern-type">
                            <option value="random">Random</option>
                            <option value="focused">Focused</option>
                            <option value="scanning">Scanning</option>
                            <option value="reading">Reading</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateData()">
                        üé≤ Generate Synthetic Data
                    </button>
                </div>
            </div>
            
            <div class="plot-container">
                <div id="quick-plot"></div>
            </div>
        </div>
        
        <!-- Tab 2: Upload CSV Data -->
        <div id="upload-data" class="tab-content">
            <div class="info-card">
                <h3>üì§ Upload Your Eye-Tracking Data</h3>
                <ul>
                    <li>CSV file format required: timestamp, x, y coordinates</li>
                    <li>Optional columns: fixation_duration, pupil_size</li>
                    <li>Data will be processed in your browser (secure & private)</li>
                </ul>
            </div>
            
            <div class="file-upload" id="file-upload-area">
                <div class="file-upload-icon">üìÅ</div>
                <h3>Drag & Drop CSV File</h3>
                <p>or click to browse</p>
                <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            
            <div id="upload-status" class="status-message"></div>
            
            <div id="upload-results" style="display: none;">
                <div class="results-container">
                    <div class="result-card">
                        <h4>üìä Data Summary</h4>
                        <div id="data-summary"></div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Visualization Settings</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label for="upload-plot-type">Plot Type:</label>
                            <select id="upload-plot-type">
                                <option value="scatter">Scatter Plot</option>
                                <option value="heatmap">Heatmap</option>
                                <option value="path">Scan Path</option>
                                <option value="histogram">Histogram</option>
                                <option value="density">Density Contour</option>
                                <option value="3d">3D Trajectory</option>
                                <option value="temporal">Temporal Analysis</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="visualizeUploadedData()">
                            üìä Visualize Data
                        </button>
                        <button class="btn btn-secondary" onclick="compareToBaseline()">
                            ü§ñ Compare to AI Baseline
                        </button>
                    </div>
                </div>
                
                <div class="plot-container">
                    <div id="upload-plot"></div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: AI Analysis -->
        <div id="ai-analysis" class="tab-content">
            <div class="info-card">
                <h3>ü§ñ AI-Powered Baseline Comparison</h3>
                <p><strong>Select Age-Appropriate ASD Baseline Model</strong></p>
                
                <div class="control-section" style="margin: 20px 0; background: white;">
                    <label for="age-group-select" style="font-weight: bold; display: block; margin-bottom: 10px;">
                        üë§ Select Age Group:
                    </label>
                    <select id="age-group-select" style="width: 100%; padding: 10px; font-size: 1em; border: 2px solid #667eea; border-radius: 5px;">
                        <option value="children">Children (Ages 3-12) - Cilia et al. (2023)</option>
                        <option value="adult">Adult - Trained on 24 participants</option>
                    </select>
                </div>
                
                <div id="children-info" class="age-info-section">
                    <p><strong>Children ASD Baseline Model (Ages 3-12)</strong></p>
                    <ul>
                        <li>Trained on 23 children with ASD (ages 3-12 years)</li>
                        <li>Optimized autoencoder: 30.7% better than original model</li>
                        <li>Validation MAE: 0.4069</li>
                        <li>Dataset: <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">Kaggle</a></li>
                        <li>Research: <a href="https://www.researchgate.net/publication/369708398" target="_blank">Cilia et al. (2023) - Eye-tracking Dataset to Support Research on Autism Spectrum Disorder</a></li>
                    </ul>
                </div>
                
                <div id="adult-info" class="age-info-section" style="display: none;">
                    <p><strong>Adult ASD Baseline Model</strong></p>
                    <ul>
                        <li>Trained on 24 adults with ASD</li>
                        <li>Same architecture as children model (8,020 parameters)</li>
                        <li>Validation MAE: 0.6065</li>
                        <li>36 trials per participant, 14,000 time samples per trial</li>
                        <li>Source: RawEyetrackingASD.mat dataset</li>
                    </ul>
                    <p><em>Note: Adult model shows different gaze patterns - higher MAE suggests more variability in adult ASD gaze behavior compared to children.</em></p>
                </div>
                
                <p style="margin-top: 15px;"><em>‚ö†Ô∏è Important: Use age-appropriate baseline for accurate screening and comparison.</em></p>
            </div>
            
            <div id="ai-loading" style="display: none;">
                <div class="spinner"></div>
                <div class="loading-text">Loading AI model...</div>
            </div>
            
            <div id="ai-status" class="status-message"></div>
            
            <div id="ai-results" style="display: none;">
                <div class="results-container">
                    <div class="result-card">
                        <h4>üéØ Similarity Score</h4>
                        <div class="score-display" id="similarity-score">--</div>
                        <div class="interpretation" id="interpretation"></div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üìà Detailed Metrics</h4>
                        <div id="detailed-metrics"></div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üî¨ Feature Analysis</h4>
                        <div id="feature-analysis"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-section" style="margin-top: 20px;">
                <p><strong>Note:</strong> Upload CSV data first in the "Upload CSV" tab, then click "Compare to AI Baseline"</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2024 Eye-Tracking Visualizer | Open Source Project</p>
            
            <p style="margin-top: 15px;"><strong>üìö Research Citations & Datasets:</strong></p>
            
            <p style="margin-top: 10px;">
                <strong>Children ASD Baseline (Ages 3-12):</strong><br>
                Cilia, N. D., Boccignone, G., Campolese, M., De Stefano, C., & Scotto di Freca, A. (2023).<br>
                <em>Eyes Tell All: Gaze Tracking, Recognition & Understanding for Assisting Children with Autism Spectrum Disorder.</em><br>
                arXiv preprint arXiv:2311.07441.<br>
                Dataset: <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">Kaggle</a> | 
                Paper: <a href="https://www.researchgate.net/publication/369708398_Eye-tracking_Dataset_to_Support_the_Research_on_Autism_Spectrum_Disorder" target="_blank">ResearchGate</a>
            </p>
            
            <p style="margin-top: 10px;">
                <strong>Adult ASD Baseline:</strong><br>
                Trained on 24 adult participants with ASD (36 trials each).<br>
                Dataset: RawEyetrackingASD.mat<br>
                Validation MAE: 0.6065 | Architecture: 28‚Üí32‚Üí48‚Üí24‚Üí48‚Üí32‚Üí28
            </p>
            
            <p style="margin-top: 15px;">
                <a href="https://github.com/rogerjs93/eyetrackingvisualiser" target="_blank">üìÇ View Source Code on GitHub</a>
            </p>
        </div>
    </div>
    
    <script>
        // Global variables
        let currentData = [];
        let baselineModel = null;
        let currentAgeGroup = 'children'; // Default to children model
        
        // Handle age group selection
        function handleAgeGroupChange() {
            const ageSelect = document.getElementById('age-group-select');
            currentAgeGroup = ageSelect.value;
            
            // Show/hide appropriate info sections
            document.getElementById('children-info').style.display = 
                currentAgeGroup === 'children' ? 'block' : 'none';
            document.getElementById('adult-info').style.display = 
                currentAgeGroup === 'adult' ? 'block' : 'none';
            
            // Reload model if needed
            loadAgeSpecificModel();
        }
        
        // Load the appropriate model based on age group
        async function loadAgeSpecificModel() {
            try {
                showStatus('ai-status', `Loading ${currentAgeGroup} baseline model...`, 'info');
                document.getElementById('ai-loading').style.display = 'block';
                
                baselineModel = new BaselineModelWeb();
                
                // Set model path based on age group
                if (currentAgeGroup === 'adult') {
                    baselineModel.modelPath = 'models/baseline_adult_asd/adult_asd_baseline.keras';
                    baselineModel.scalerPath = 'models/baseline_adult_asd/scaler.json';
                    baselineModel.threshold = 0.6065; // Adult threshold
                } else {
                    baselineModel.modelPath = 'models/baseline_children_asd/optimized_autoencoder.keras';
                    baselineModel.scalerPath = 'models/baseline_children_asd/scaler.json';
                    baselineModel.threshold = 0.4069; // Children threshold
                }
                
                await baselineModel.loadModel();
                
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', `‚úÖ ${currentAgeGroup === 'children' ? 'Children' : 'Adult'} baseline model loaded successfully!`, 'success');
                
                console.log(`‚úÖ ${currentAgeGroup} baseline model loaded`);
            } catch (error) {
                console.error('‚ùå Failed to load model:', error);
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', '‚ö†Ô∏è AI model failed to load. CSV upload still works for visualization.', 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Eye-Tracking Visualizer Loaded');
            
            // Setup age group selector
            const ageSelect = document.getElementById('age-group-select');
            ageSelect.addEventListener('change', handleAgeGroupChange);
            
            // Try to pre-load the AI model (children by default)
            await loadAgeSpecificModel();
            
            // Setup file upload drag & drop
            const uploadArea = document.getElementById('file-upload-area');
            
            uploadArea.addEventListener('click', () => {
                document.getElementById('csv-file-input').click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        });
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Set button active
            event.target.closest('.tab-button').classList.add('active');
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Generate synthetic data
        function generateData() {
            const numPoints = parseInt(document.getElementById('num-points').value);
            const patternType = document.getElementById('pattern-type').value;
            const plotType = document.getElementById('plot-type').value;
            
            currentData = generateSyntheticData(numPoints, patternType);
            
            visualizePlot('quick-plot', currentData, plotType, 'Synthetic Eye-Tracking Data');
        }
        
        // Generate synthetic eye-tracking data
        function generateSyntheticData(n, pattern) {
            const data = [];
            let centerX = 50, centerY = 50;
            
            for (let i = 0; i < n; i++) {
                let x, y;
                
                switch(pattern) {
                    case 'focused':
                        x = centerX + (Math.random() - 0.5) * 20;
                        y = centerY + (Math.random() - 0.5) * 20;
                        break;
                    case 'scanning':
                        x = (i / n) * 80 + 10;
                        y = 30 + Math.sin(i * 0.3) * 20;
                        break;
                    case 'reading':
                        const line = Math.floor(i / (n/5));
                        x = 10 + (i % (n/5)) / (n/5) * 80;
                        y = 20 + line * 15;
                        break;
                    default: // random
                        x = Math.random() * 100;
                        y = Math.random() * 100;
                }
                
                data.push({
                    timestamp: i * 100,
                    x: Math.max(0, Math.min(100, x)),
                    y: Math.max(0, Math.min(100, y)),
                    fixation_duration: 150 + Math.random() * 200,
                    pupil_size: 3 + Math.random() * 2
                });
            }
            
            return data;
        }
        
        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            handleFile(file);
        }
        
        function handleFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('upload-status', '‚ùå Please select a CSV file', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    currentData = parseCSV(csv);
                    
                    showStatus('upload-status', `‚úÖ Successfully loaded ${currentData.length} data points`, 'success');
                    
                    // Show results section
                    document.getElementById('upload-results').style.display = 'block';
                    
                    // Display summary
                    displayDataSummary(currentData);
                    
                    // Auto-visualize
                    visualizeUploadedData();
                    
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    showStatus('upload-status', `‚ùå Error parsing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Parse CSV
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                });
                
                // Parse required fields
                data.push({
                    timestamp: parseFloat(row.timestamp || row.time || i * 100),
                    x: parseFloat(row.x || row.gaze_x || 0),
                    y: parseFloat(row.y || row.gaze_y || 0),
                    fixation_duration: parseFloat(row.fixation_duration || 200),
                    pupil_size: parseFloat(row.pupil_size || 3.5)
                });
            }
            
            return data;
        }
        
        // Display data summary
        function displayDataSummary(data) {
            const summary = document.getElementById('data-summary');
            
            const stats = {
                points: data.length,
                duration: ((data[data.length-1].timestamp - data[0].timestamp) / 1000).toFixed(2),
                avgX: (data.reduce((sum, d) => sum + d.x, 0) / data.length).toFixed(2),
                avgY: (data.reduce((sum, d) => sum + d.y, 0) / data.length).toFixed(2)
            };
            
            summary.innerHTML = `
                <p><strong>Total Points:</strong> ${stats.points}</p>
                <p><strong>Duration:</strong> ${stats.duration} seconds</p>
                <p><strong>Average X:</strong> ${stats.avgX}</p>
                <p><strong>Average Y:</strong> ${stats.avgY}</p>
            `;
        }
        
        // Visualize uploaded data
        function visualizeUploadedData() {
            if (currentData.length === 0) {
                showStatus('upload-status', '‚ùå No data to visualize', 'error');
                return;
            }
            
            const plotType = document.getElementById('upload-plot-type').value;
            visualizePlot('upload-plot', currentData, plotType, 'Uploaded Eye-Tracking Data');
        }
        
        // Compare to baseline
        async function compareToBaseline() {
            if (currentData.length === 0) {
                showStatus('upload-status', '‚ùå No data loaded. Please upload CSV first.', 'error');
                return;
            }
            
            if (!baselineModel || !baselineModel.isModelLoaded) {
                showStatus('upload-status', '‚ùå AI model not loaded', 'error');
                return;
            }
            
            // Switch to AI Analysis tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('ai-analysis').classList.add('active');
            document.querySelectorAll('.tab-button')[2].classList.add('active');
            
            // Show loading
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-results').style.display = 'none';
            
            try {
                const results = await baselineModel.compareToBaseline(currentData);
                
                // Hide loading
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-results').style.display = 'block';
                
                // Display results
                document.getElementById('similarity-score').textContent = results.similarityScore + '%';
                document.getElementById('interpretation').textContent = results.interpretation;
                
                // Detailed metrics
                document.getElementById('detailed-metrics').innerHTML = `
                    <p><strong>Reconstruction Error:</strong> ${results.reconstructionError.toFixed(4)}</p>
                    <p><strong>Data Points:</strong> ${currentData.length}</p>
                    <p><strong>Features Analyzed:</strong> 28</p>
                `;
                
                // Feature analysis (top deviations)
                const featureNames = ['X Mean', 'X Std', 'X Min', 'X Max', 'Y Mean', 'Y Std', 'Y Min', 'Y Max',
                    'Fixation Duration Mean', 'Fixation Duration Std', 'Fixation Count', 'Saccade Velocity Mean',
                    'Saccade Velocity Std', 'Saccade Amplitude Mean', 'Saccade Amplitude Std', 'Pupil Size Mean',
                    'Pupil Size Std', 'Spatial Coverage', 'Fixation Dispersion', 'Scan Path Length',
                    'Gaze Entropy', 'Center Bias', 'Edge Bias', 'ROI Focus', 'V/H Ratio',
                    'Temporal Consistency', 'Attention Switches', 'Revisit Rate'];
                
                let featureHTML = '<table style="width:100%; border-collapse: collapse;">';
                featureHTML += '<tr><th style="text-align:left; padding: 5px; border-bottom: 1px solid #ddd;">Feature</th>';
                featureHTML += '<th style="text-align:right; padding: 5px; border-bottom: 1px solid #ddd;">Z-Score</th></tr>';
                
                results.zScores.forEach((z, i) => {
                    const absZ = Math.abs(z);
                    if (absZ > 1.5) {  // Show significant deviations
                        const color = absZ > 2 ? '#dc3545' : '#ffc107';
                        featureHTML += `<tr style="background: ${color}22;">`;
                        featureHTML += `<td style="padding: 5px;">${featureNames[i]}</td>`;
                        featureHTML += `<td style="padding: 5px; text-align: right;">${z.toFixed(2)}</td>`;
                        featureHTML += '</tr>';
                    }
                });
                
                featureHTML += '</table>';
                document.getElementById('feature-analysis').innerHTML = featureHTML;
                
                showStatus('ai-status', '‚úÖ Analysis complete!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error during comparison:', error);
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Visualization function (simplified - add full Plotly code here)
        function visualizePlot(containerId, data, plotType, title) {
            const x = data.map(d => d.x);
            const y = data.map(d => d.y);
            
            let plotData, layout;
            
            switch(plotType) {
                case 'scatter':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        marker: {
                            size: 8,
                            color: data.map((d, i) => i),
                            colorscale: 'Viridis',
                            showscale: true
                        }
                    }];
                    break;
                    
                case 'heatmap':
                    // Create 2D histogram for heatmap
                    plotData = [{
                        x: x,
                        y: y,
                        type: 'histogram2d',
                        colorscale: 'Hot',
                        reversescale: true
                    }];
                    break;
                    
                case 'path':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'lines+markers',
                        type: 'scatter',
                        line: { color: '#667eea', width: 2 },
                        marker: { size: 5, color: '#764ba2' }
                    }];
                    break;
                    
                default:
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter'
                    }];
            }
            
            layout = {
                title: title,
                xaxis: { title: 'X Position', range: [0, 100] },
                yaxis: { title: 'Y Position', range: [0, 100] },
                height: 500
            };
            
            Plotly.newPlot(containerId, plotData, layout, {responsive: true});
        }
    </script>
</body>
</html>
