<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye-Tracking Data Visualizer - AI-Powered Analysis</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="baseline_model_web.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            position: relative;
            z-index: 2;
        }
        
        /* Circular Text Animation */
        .circular-text-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 0 auto;
            animation: fadeInUp 1s ease-out;
        }
        
        .circular-text {
            position: absolute;
            width: 100%;
            height: 100%;
            animation: rotate 20s linear infinite;
        }
        
        .circular-text span {
            position: absolute;
            left: 50%;
            top: 0;
            transform-origin: 0 200px;
            font-size: 1.3em;
            font-weight: 600;
            opacity: 0;
            animation: letterFadeIn 0.5s ease-out forwards;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes letterFadeIn {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Floating background elements */
        .header::before,
        .header::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        
        .header::before {
            width: 300px;
            height: 300px;
            background: white;
            top: -150px;
            left: -100px;
            animation-delay: 0s;
        }
        
        .header::after {
            width: 200px;
            height: 200px;
            background: white;
            bottom: -100px;
            right: -50px;
            animation-delay: 3s;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-20px) rotate(5deg);
            }
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            margin-top: 10px;
            position: relative;
            z-index: 2;
            animation: fadeIn 1.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 0.95; }
        }
        
        .header .beta-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px 5px rgba(255, 255, 255, 0);
            }
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        
        .tab-button:hover {
            background: #e9ecef;
            color: #495057;
            transform: translateY(-2px);
        }
        
        .tab-button:hover::after {
            width: 80%;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: transparent;
            background: white;
        }
        
        .tab-button.active::after {
            width: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .tab-icon {
            font-size: 1.3em;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Info Cards */
        .info-card {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            opacity: 0;
            animation: slideInLeft 0.6s ease-out forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .info-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .info-card h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
        
        .info-card ul {
            margin-left: 20px;
            color: #495057;
        }
        
        .info-card li {
            margin: 5px 0;
        }
        
        /* Controls */
        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
            transition: all 0.3s ease;
        }
        
        .control-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .control-section h3 {
            margin-bottom: 15px;
            color: #495057;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        .control-item label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .control-item select,
        .control-item input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .control-item select:focus,
        .control-item input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* File Upload */
        .file-upload {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .file-upload:hover {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload.drag-over {
            border-color: #667eea;
            background: #e7f3ff;
        }
        
        .file-upload-icon {
            font-size: 3em;
            color: #6c757d;
            margin-bottom: 15px;
        }
        
        .file-upload input[type="file"] {
            display: none;
        }
        
        /* Results Display */
        .results-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .result-card h4 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .score-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        .interpretation {
            text-align: center;
            font-size: 1.2em;
            color: #495057;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 8px;
        }
        
        /* Plots */
        .plot-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-top: 20px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            color: #6c757d;
            margin-top: 10px;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        /* Footer */
        .footer {
            background: #343a40;
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* Age Info Sections */
        .age-info-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .age-info-section ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .age-info-section li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .tab-button {
                font-size: 0.9em;
                padding: 15px 10px;
            }
            
            .tab-icon {
                display: none;
            }
            
            .control-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="circular-text-container" id="circularTextContainer"></div>
            <p>AI-Powered Analysis with Age-Specific ASD Baselines</p>
            <div class="beta-badge">‚ú® TensorFlow.js AI Features</div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-button active" onclick="switchTab('quick-start')">
                <span class="tab-icon">‚ö°</span>
                <span>Quick Start</span>
            </button>
            <button class="tab-button" onclick="switchTab('upload-data')">
                <span class="tab-icon">üì§</span>
                <span>Upload CSV</span>
            </button>
            <button class="tab-button" onclick="switchTab('ai-analysis')">
                <span class="tab-icon">ü§ñ</span>
                <span>AI Analysis</span>
            </button>
        </div>
        
        <!-- Tab 1: Quick Start (Synthetic Data) -->
        <div id="quick-start" class="tab-content active">
            <div class="info-card">
                <h3>‚ú® Quick Start with Synthetic Data</h3>
                <ul>
                    <li>Generate realistic eye-tracking patterns instantly</li>
                    <li>Explore different visualization types</li>
                    <li>Perfect for testing and demonstrations</li>
                </ul>
            </div>
            
            <div class="control-section">
                <h3>Visualization Settings</h3>
                <div class="control-grid">
                    <div class="control-item">
                        <label for="plot-type">Plot Type:</label>
                        <select id="plot-type">
                            <option value="scatter">Scatter Plot</option>
                            <option value="heatmap">Heatmap</option>
                            <option value="path">Scan Path</option>
                            <option value="histogram">Histogram</option>
                            <option value="density">Density Contour</option>
                            <option value="3d">3D Trajectory</option>
                            <option value="temporal">Temporal Analysis</option>
                        </select>
                    </div>
                    
                    <div class="control-item">
                        <label for="num-points">Number of Points:</label>
                        <input type="number" id="num-points" value="100" min="10" max="1000">
                    </div>
                    
                    <div class="control-item">
                        <label for="pattern-type">Pattern Type:</label>
                        <select id="pattern-type">
                            <option value="random">Random</option>
                            <option value="focused">Focused</option>
                            <option value="scanning">Scanning</option>
                            <option value="reading">Reading</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateData()">
                        üé≤ Generate Synthetic Data
                    </button>
                </div>
            </div>
            
            <div class="plot-container">
                <div id="quick-plot"></div>
            </div>
        </div>
        
        <!-- Tab 2: Upload CSV Data -->
        <div id="upload-data" class="tab-content">
            <div class="info-card">
                <h3>üì§ Upload Your Eye-Tracking Data</h3>
                <ul>
                    <li>CSV file format required: timestamp, x, y coordinates</li>
                    <li>Optional columns: fixation_duration, pupil_size</li>
                    <li>Data will be processed in your browser (secure & private)</li>
                </ul>
            </div>
            
            <div class="file-upload" id="file-upload-area">
                <div class="file-upload-icon">üìÅ</div>
                <h3>Drag & Drop CSV File</h3>
                <p>or click to browse</p>
                <input type="file" id="csv-file-input" accept=".csv" onchange="handleFileSelect(event)">
            </div>
            
            <div id="upload-status" class="status-message"></div>
            
            <div id="upload-results" style="display: none;">
                <div class="results-container">
                    <div class="result-card">
                        <h4>üìä Data Summary</h4>
                        <div id="data-summary"></div>
                    </div>
                </div>
                
                <div class="control-section">
                    <h3>Visualization Settings</h3>
                    <div class="control-grid">
                        <div class="control-item">
                            <label for="upload-plot-type">Plot Type:</label>
                            <select id="upload-plot-type">
                                <option value="scatter">Scatter Plot</option>
                                <option value="heatmap">Heatmap</option>
                                <option value="path">Scan Path</option>
                                <option value="histogram">Histogram</option>
                                <option value="density">Density Contour</option>
                                <option value="3d">3D Trajectory</option>
                                <option value="temporal">Temporal Analysis</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label for="coordinate-mode">Coordinate Mode:</label>
                            <select id="coordinate-mode" onchange="updateCoordinateMode()">
                                <option value="raw">Raw Coordinates (for stimulus overlay)</option>
                                <option value="normalized">Normalized 0-100 (for AI comparison)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="visualizeUploadedData()">
                            üìä Visualize Data
                        </button>
                        <button class="btn btn-secondary" onclick="compareToBaseline()">
                            ü§ñ Compare to AI Baseline
                        </button>
                    </div>
                </div>
                
                <div class="plot-container">
                    <div id="upload-plot"></div>
                </div>
            </div>
        </div>
        
        <!-- Tab 3: AI Analysis -->
        <div id="ai-analysis" class="tab-content">
            <div class="info-card">
                <h3>ü§ñ AI-Powered Baseline Comparison</h3>
                <p><strong>Select Baseline Model for Comparison</strong></p>
                
                <div class="control-section" style="margin: 20px 0; background: white;">
                    <label for="age-group-select" style="font-weight: bold; display: block; margin-bottom: 10px;">
                        üë§ Select Baseline Population:
                    </label>
                    <select id="age-group-select" style="width: 100%; padding: 10px; font-size: 1em; border: 2px solid #667eea; border-radius: 5px;">
                        <option value="children">Children with ASD (Ages 3-12) - Cilia et al. (2023)</option>
                        <option value="adult">Adults with ASD - Trained on 24 participants</option>
                        <option value="neurotypical">Neurotypical (Healthy Controls) - ETDB v1.0</option>
                    </select>
                </div>
                
                <div id="children-info" class="age-info-section">
                    <p><strong>üßí Children ASD Baseline Model (Ages 3-12)</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> 23 children with ASD diagnosis (3-12 years)</li>
                            <li><strong>Task:</strong> Free viewing of social scenes and interactive stimuli</li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Sampling rate: Variable (250-500 Hz recommended)</li>
                                    <li>Calibration: 5-point or 9-point procedure</li>
                                    <li>Session duration: ~10-15 minutes per participant</li>
                                </ul>
                            </li>
                            <li><strong>Data Format:</strong> CSV with columns: timestamp, x, y, fixation_duration, pupil_size</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (Unsupervised Learning)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28</li>
                            <li><strong>Features Extracted:</strong> 28 statistical features including:
                                <ul>
                                    <li>Spatial: mean, std, min, max positions (X, Y)</li>
                                    <li>Temporal: fixation duration, saccade velocity/amplitude</li>
                                    <li>Behavioral: spatial coverage, entropy, center bias, scan path length</li>
                                </ul>
                            </li>
                            <li><strong>Training:</strong> 80/20 train-val split, Adam optimizer, MSE loss</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.4069</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Use any eye-tracker with ‚â•250 Hz sampling rate</li>
                            <li>Perform 5-point or 9-point calibration</li>
                            <li>Record free viewing or social scene tasks (10-15 min)</li>
                            <li>Export as CSV with: timestamp, x, y coordinates</li>
                            <li>Coordinates can be raw pixels or normalized</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìö Research:</strong> <a href="https://www.researchgate.net/publication/369708398" target="_blank">Cilia et al. (2023)</a> | 
                    <strong>üìä Dataset:</strong> <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">Kaggle</a></p>
                </div>
                
                <div id="adult-info" class="age-info-section" style="display: none;">
                    <p><strong>üë® Adult ASD Baseline Model</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> 24 adults with ASD diagnosis</li>
                            <li><strong>Task:</strong> 36 trials per participant (864 total trials)</li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Trial duration: ~14,000 time samples per trial</li>
                                    <li>Sampling rate: Estimated 250-500 Hz</li>
                                    <li>Viewing distance: Controlled laboratory setting</li>
                                </ul>
                            </li>
                            <li><strong>Data Format:</strong> MATLAB .mat file ‚Üí converted to CSV format</li>
                            <li><strong>Original Source:</strong> RawEyetrackingASD.mat dataset</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (same as children model)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28 (8,020 parameters)</li>
                            <li><strong>Features:</strong> Identical 28 features as children model for consistency</li>
                            <li><strong>Training:</strong> 80/20 split, Adam optimizer, early stopping (patience=15)</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.6065</li>
                            <li><strong>Note:</strong> Higher MAE reflects greater variability in adult ASD gaze patterns</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Recruit adult participants (18+ years) with ASD diagnosis</li>
                            <li>Use eye-tracker with ‚â•250 Hz sampling (Tobii, EyeLink, etc.)</li>
                            <li>Multiple trials per participant (30-40 recommended)</li>
                            <li>Record during natural viewing or cognitive tasks</li>
                            <li>Export with timestamp, x, y, and optional pupil diameter</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìä Dataset:</strong> <a href="https://www.kaggle.com/datasets/haocai1/raweyetrackingasd" target="_blank">Kaggle - RawEyetrackingASD</a></p>
                </div>
                
                <div id="neurotypical-info" class="age-info-section" style="display: none;">
                    <p><strong>üòä Neurotypical Baseline Model (Healthy Controls)</strong></p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="margin-top: 0; color: #667eea;">üìã Data Collection Methodology</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Participants:</strong> Healthy individuals (ages 7-80 years)</li>
                            <li><strong>Datasets Used:</strong> 5 experiments from ETDB v1.0
                                <ul>
                                    <li>Baseline: Free viewing of complex images</li>
                                    <li>Age study: Comparing different age groups</li>
                                    <li>Memory I & II: Visual memory tasks</li>
                                    <li>Patch: Texture pattern viewing</li>
                                </ul>
                            </li>
                            <li><strong>Recording Settings:</strong>
                                <ul>
                                    <li>Eye-tracker: Various (see ETDB documentation)</li>
                                    <li>Sampling rates: 250-500 Hz</li>
                                    <li>Display: 1024√ó768 to 1920√ó1080 resolution</li>
                                    <li>Viewing distance: 60-70 cm typical</li>
                                </ul>
                            </li>
                            <li><strong>Total Trials:</strong> 836 trials across multiple experiments</li>
                            <li><strong>Data Format:</strong> HDF5 with keys: x, y, trial, SUBJECTINDEX, fixation markers</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">ü§ñ Model Architecture</h4>
                        <ul style="margin: 10px 0;">
                            <li><strong>Type:</strong> Autoencoder (identical to ASD models)</li>
                            <li><strong>Architecture:</strong> 28‚Üí32‚Üí48‚Üí24(latent)‚Üí48‚Üí32‚Üí28</li>
                            <li><strong>Features:</strong> Same 28 features (spatial, temporal, behavioral)</li>
                            <li><strong>Training:</strong> 80/20 split, 100 epochs, early stopping</li>
                            <li><strong>Performance:</strong> Validation MAE: 0.3478 (best performance)</li>
                            <li><strong>Interpretation:</strong> Lower MAE indicates more consistent, predictable gaze patterns in neurotypical population</li>
                        </ul>
                        
                        <h4 style="color: #667eea;">üéØ To Collect Similar Data:</h4>
                        <ol style="margin: 10px 0;">
                            <li>Screen healthy participants (no neurological conditions)</li>
                            <li>Use research-grade eye-tracker (‚â•250 Hz)</li>
                            <li>Tasks: Free viewing of complex scenes (natural images, faces, etc.)</li>
                            <li>Include diverse age range for robust baseline</li>
                            <li>Standardize viewing distance (~60-70 cm) and display size</li>
                            <li>Multiple trials per participant (10-30 recommended)</li>
                            <li>Export: timestamp, x, y in screen coordinates or degrees of visual angle</li>
                        </ol>
                    </div>
                    
                    <p><strong>üìö Research:</strong> <a href="https://doi.org/10.1038/sdata.2016.126" target="_blank">Wilming et al. (2017) - Nature Scientific Data</a> | 
                    <strong>üìä Dataset:</strong> <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.9pf75" target="_blank">ETDB v1.0 - Dryad</a></p>
                </div>
                
                <p style="margin-top: 15px;"><em>‚ö†Ô∏è Important: Select appropriate baseline for meaningful comparison. Neurotypical baseline provides reference for healthy population, while ASD baselines are age-specific.</em></p>
            </div>
            
            <div id="ai-loading" style="display: none;">
                <div class="spinner"></div>
                <div class="loading-text">Loading AI model...</div>
            </div>
            
            <div id="ai-status" class="status-message"></div>
            
            <div id="ai-results" style="display: none;">
                <div class="results-container">
                    <div class="result-card">
                        <h4>üéØ Similarity Score</h4>
                        <div class="score-display" id="similarity-score">--</div>
                        <div class="interpretation" id="interpretation"></div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üìà Detailed Metrics</h4>
                        <div id="detailed-metrics"></div>
                    </div>
                    
                    <div class="result-card">
                        <h4>üî¨ Feature Analysis</h4>
                        <div id="feature-analysis"></div>
                    </div>
                </div>
            </div>
            
            <div class="control-section" style="margin-top: 20px;">
                <p><strong>Note:</strong> Upload CSV data first in the "Upload CSV" tab, then click "Compare to AI Baseline"</p>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>&copy; 2024 Eye-Tracking Visualizer | Open Source Project</p>
            
            <p style="margin-top: 15px;"><strong>üìö Research Citations & Datasets:</strong></p>
            
            <p style="margin-top: 10px;">
                <strong>Children ASD Baseline (Ages 3-12):</strong><br>
                Cilia, N. D., Boccignone, G., Campolese, M., De Stefano, C., & Scotto di Freca, A. (2023).<br>
                <em>Eyes Tell All: Gaze Tracking, Recognition & Understanding for Assisting Children with Autism Spectrum Disorder.</em><br>
                arXiv preprint arXiv:2311.07441.<br>
                Dataset: <a href="https://www.kaggle.com/datasets/imtkaggleteam/eye-tracking-autism" target="_blank">Kaggle</a> | 
                Paper: <a href="https://www.researchgate.net/publication/369708398_Eye-tracking_Dataset_to_Support_the_Research_on_Autism_Spectrum_Disorder" target="_blank">ResearchGate</a>
            </p>
            
            <p style="margin-top: 10px;">
                <strong>Adult ASD Baseline:</strong><br>
                Trained on 24 adult participants with ASD (36 trials each).<br>
                Source: RawEyetrackingASD.mat<br>
                Dataset: <a href="https://www.kaggle.com/datasets/haocai1/raweyetrackingasd" target="_blank">Kaggle - Raw Eye Tracking ASD</a><br>
                Validation MAE: 0.6065 | Architecture: 28‚Üí32‚Üí48‚Üí24‚Üí48‚Üí32‚Üí28
            </p>
            
            <p style="margin-top: 10px;">
                <strong>Neurotypical Baseline (Healthy Controls):</strong><br>
                Wilming, N., Onat, S., Ossand√≥n, J. P., A√ßƒ±k, A., Kietzmann, T. C., Kaspar, K., Gameiro, R. R., Vormberg, A., & K√∂nig, P. (2017).<br>
                <em>An extensive dataset of eye movements during viewing of complex images.</em><br>
                Scientific Data, 4, 160126.<br>
                Dataset: <a href="https://datadryad.org/stash/dataset/doi:10.5061/dryad.9pf75" target="_blank">Dryad - ETDB v1.0</a> | 
                Paper: <a href="https://doi.org/10.1038/sdata.2016.126" target="_blank">Nature Scientific Data</a><br>
                836 trials from diverse age range (7-80 years) | Validation MAE: 0.3478
            </p>
            
            <p style="margin-top: 15px;">
                <a href="https://github.com/rogerjs93/eyetrackingvisualiser" target="_blank">üìÇ View Source Code on GitHub</a>
            </p>
        </div>
    </div>
    
    <script>
        // Global variables - SEPARATED by data source
        let syntheticData = [];  // For generated synthetic data
        let uploadedRawData = [];  // For uploaded CSV raw coordinates
        let uploadedNormalizedData = [];  // For uploaded CSV normalized coordinates
        let baselineModel = null;
        let currentAgeGroup = 'children'; // Default to children model
        let coordinateMode = 'raw'; // Default to raw mode
        
        // Handle age group selection
        function handleAgeGroupChange() {
            const ageSelect = document.getElementById('age-group-select');
            currentAgeGroup = ageSelect.value;
            
            // Show/hide appropriate info sections
            document.getElementById('children-info').style.display = 
                currentAgeGroup === 'children' ? 'block' : 'none';
            document.getElementById('adult-info').style.display = 
                currentAgeGroup === 'adult' ? 'block' : 'none';
            document.getElementById('neurotypical-info').style.display = 
                currentAgeGroup === 'neurotypical' ? 'block' : 'none';
            
            // Reload model if needed
            loadAgeSpecificModel();
        }
        
        // Load the appropriate model based on age group
        async function loadAgeSpecificModel() {
            try {
                const modelNames = {
                    'children': 'Children ASD',
                    'adult': 'Adult ASD',
                    'neurotypical': 'Neurotypical'
                };
                showStatus('ai-status', `Loading ${modelNames[currentAgeGroup]} baseline model...`, 'info');
                document.getElementById('ai-loading').style.display = 'block';
                
                baselineModel = new BaselineModelWeb();
                
                // Set model path based on age group
                if (currentAgeGroup === 'adult') {
                    baselineModel.modelPath = 'models/baseline_adult_asd_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_adult_asd_tfjs/scaler.json';
                    baselineModel.threshold = 0.6065; // Adult threshold
                } else if (currentAgeGroup === 'neurotypical') {
                    baselineModel.modelPath = 'models/baseline_neurotypical_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_neurotypical_tfjs/scaler.json';
                    baselineModel.threshold = 0.3478; // Neurotypical threshold
                } else {
                    baselineModel.modelPath = 'models/baseline_children_asd_tfjs/model.json';
                    baselineModel.scalerPath = 'models/baseline_children_asd_tfjs/scaler.json';
                    baselineModel.threshold = 0.4069; // Children threshold
                }
                
                await baselineModel.loadModel();
                
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', `‚úÖ ${modelNames[currentAgeGroup]} baseline model loaded successfully!`, 'success');
                
                console.log(`‚úÖ ${currentAgeGroup} baseline model loaded`);
            } catch (error) {
                console.error('‚ùå Failed to load model:', error);
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', '‚ö†Ô∏è AI model failed to load. CSV upload still works for visualization.', 'error');
            }
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Eye-Tracking Visualizer Loaded');
            
            // Setup age group selector
            const ageSelect = document.getElementById('age-group-select');
            ageSelect.addEventListener('change', handleAgeGroupChange);
            
            // Try to pre-load the AI model (children by default)
            await loadAgeSpecificModel();
            
            // Setup file upload drag & drop
            const uploadArea = document.getElementById('file-upload-area');
            
            uploadArea.addEventListener('click', () => {
                document.getElementById('csv-file-input').click();
            });
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
        });
        
        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Set button active
            event.target.closest('.tab-button').classList.add('active');
        }
        
        // Show status message
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }
        
        // Generate synthetic data - INDEPENDENT function
        function generateData() {
            const numPoints = parseInt(document.getElementById('num-points').value);
            const patternType = document.getElementById('pattern-type').value;
            const plotType = document.getElementById('plot-type').value;
            
            // Generate and store in synthetic data variable
            syntheticData = generateSyntheticData(numPoints, patternType);
            
            console.log(`‚úÖ Generated ${syntheticData.length} synthetic data points`);
            
            // Visualize in quick-plot container ONLY
            visualizePlot('quick-plot', syntheticData, plotType, 'Synthetic Eye-Tracking Data');
        }
        
        // Generate synthetic eye-tracking data
        function generateSyntheticData(n, pattern) {
            const data = [];
            let centerX = 50, centerY = 50;
            
            for (let i = 0; i < n; i++) {
                let x, y;
                
                switch(pattern) {
                    case 'focused':
                        x = centerX + (Math.random() - 0.5) * 20;
                        y = centerY + (Math.random() - 0.5) * 20;
                        break;
                    case 'scanning':
                        x = (i / n) * 80 + 10;
                        y = 30 + Math.sin(i * 0.3) * 20;
                        break;
                    case 'reading':
                        const line = Math.floor(i / (n/5));
                        x = 10 + (i % (n/5)) / (n/5) * 80;
                        y = 20 + line * 15;
                        break;
                    default: // random
                        x = Math.random() * 100;
                        y = Math.random() * 100;
                }
                
                data.push({
                    timestamp: i * 100,
                    x: Math.max(0, Math.min(100, x)),
                    y: Math.max(0, Math.min(100, y)),
                    fixation_duration: 150 + Math.random() * 200,
                    pupil_size: 3 + Math.random() * 2
                });
            }
            
            return data;
        }
        
        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            handleFile(file);
        }
        
        function handleFile(file) {
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('upload-status', '‚ùå Please select a CSV file', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const csv = e.target.result;
                    const parsedData = parseCSV(csv);
                    
                    // Early sampling if data is huge (before any processing)
                    const MAX_POINTS = 5000;
                    let displayCount = parsedData.length;
                    if (parsedData.length > MAX_POINTS) {
                        displayCount = MAX_POINTS;
                        showStatus('upload-status', `‚úÖ Loaded ${parsedData.length} points (will visualize ${MAX_POINTS} sampled points for performance)`, 'success');
                    } else {
                        showStatus('upload-status', `‚úÖ Successfully loaded ${parsedData.length} data points`, 'success');
                    }
                    
                    // Show results section
                    document.getElementById('upload-results').style.display = 'block';
                    
                    // Display summary using current coordinate mode
                    const dataToDisplay = coordinateMode === 'raw' ? uploadedRawData : uploadedNormalizedData;
                    displayDataSummary(dataToDisplay);
                    
                    // Auto-visualize
                    visualizeUploadedData();
                    
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    showStatus('upload-status', `‚ùå Error parsing CSV: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Parse CSV - STORES in uploaded data variables
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length === 0) {
                throw new Error('CSV file is empty');
            }
            
            const headers = lines[0].toLowerCase().split(',').map(h => h.trim());
            console.log('üìã CSV Headers found:', headers.length, 'columns');
            console.log('üìã First 10 headers:', headers.slice(0, 10));
            
            // Detect column indices - more sophisticated matching for eye-tracking data
            // Look for patterns: x, gaze_x, pupil x, x [px], etc.
            let xIndex = -1;
            let yIndex = -1;
            
            // Priority 1: Exact matches
            xIndex = headers.findIndex(h => h === 'x' || h === 'gaze_x' || h === 'x_pos');
            yIndex = headers.findIndex(h => h === 'y' || h === 'gaze_y' || h === 'y_pos');
            
            // Priority 2: Pupil position columns (common in eye-trackers)
            if (xIndex === -1) {
                xIndex = headers.findIndex(h => h.includes('pupil') && h.includes('x') && h.includes('[px]'));
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex(h => h.includes('pupil') && h.includes('y') && h.includes('[px]'));
            }
            
            // Priority 3: Any column with coordinate-like names
            if (xIndex === -1) {
                xIndex = headers.findIndex(h => 
                    (h.includes('x') && h.includes('pos')) ||
                    (h.includes('x') && h.includes('coord')) ||
                    h.endsWith('_x') || h.endsWith(' x')
                );
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex(h => 
                    (h.includes('y') && h.includes('pos')) ||
                    (h.includes('y') && h.includes('coord')) ||
                    h.endsWith('_y') || h.endsWith(' y')
                );
            }
            
            // Priority 4: Fallback - first column with x or y (but avoid index columns)
            if (xIndex === -1) {
                xIndex = headers.findIndex((h, i) => i > 2 && h.includes('x'));
            }
            if (yIndex === -1) {
                yIndex = headers.findIndex((h, i) => i > 2 && h.includes('y'));
            }
            
            if (xIndex === -1 || yIndex === -1) {
                console.error('‚ùå Available headers:', headers);
                throw new Error(`Missing coordinate columns. Please ensure CSV has x and y coordinate columns.`);
            }
            
            console.log(`‚úÖ Using columns: X="${lines[0].split(',')[xIndex].trim()}" (index ${xIndex}), Y="${lines[0].split(',')[yIndex].trim()}" (index ${yIndex})`);
            
            const parsedData = [];
            let skippedRows = 0;
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue; // Skip empty lines
                
                const values = lines[i].split(',');
                
                // Debug first row
                if (i === 1) {
                    console.log('üîç First data row values:', values);
                    console.log(`üîç Value at xIndex ${xIndex}:`, values[xIndex]);
                    console.log(`üîç Value at yIndex ${yIndex}:`, values[yIndex]);
                }
                
                // Parse coordinates from detected columns
                const x = parseFloat(values[xIndex]);
                const y = parseFloat(values[yIndex]);
                
                // Skip invalid points
                if (isNaN(x) || isNaN(y)) {
                    skippedRows++;
                    continue;
                }
                
                const point = {
                    timestamp: parseFloat(values[headers.indexOf('timestamp')] || values[headers.indexOf('time')] || i * 100),
                    x: x,
                    y: y,
                    fixation_duration: parseFloat(values[headers.indexOf('fixation_duration')] || values[headers.indexOf('duration')] || 200),
                    pupil_size: parseFloat(values[headers.indexOf('pupil_size')] || values[headers.indexOf('pupil')] || 3.5)
                };
                
                parsedData.push(point);
            }
            
            if (skippedRows > 0) {
                console.log(`‚ö†Ô∏è Skipped ${skippedRows} invalid rows`);
            }
            
            if (parsedData.length === 0) {
                throw new Error('No valid data points found in CSV');
            }
            
            // Calculate statistics before storing
            const xValues = parsedData.map(d => d.x);
            const yValues = parsedData.map(d => d.y);
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            console.log(`‚úÖ Parsed ${parsedData.length} data points from CSV`);
            console.log(`üìä Raw coordinate ranges: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}] (range: ${xRange.toFixed(2)}), Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}] (range: ${yRange.toFixed(2)})`);
            
            // Check for suspicious data patterns
            if (xRange < 10 && yRange < 10) {
                console.warn('‚ö†Ô∏è WARNING: Very small coordinate range detected. Data might be normalized or in different units.');
            }
            
            // Count zeros or negative values
            const zeroPoints = parsedData.filter(d => d.x === 0 && d.y === 0).length;
            const negativePoints = parsedData.filter(d => d.x < 0 || d.y < 0).length;
            if (zeroPoints > 0) {
                console.warn(`‚ö†Ô∏è Found ${zeroPoints} points at (0,0) - these might be invalid tracking points`);
            }
            if (negativePoints > 0) {
                console.warn(`‚ö†Ô∏è Found ${negativePoints} points with negative coordinates`);
            }
            
            // Store in UPLOADED data variables (not synthetic)
            uploadedRawData = parsedData;
            uploadedNormalizedData = normalizeCoordinates(parsedData);
            
            // Return raw by default
            return uploadedRawData;
        }
        
        // Normalize coordinates to 0-100 range
        function normalizeCoordinates(data) {
            if (data.length === 0) return data;
            
            // Find min/max for x and y
            const xValues = data.map(d => d.x);
            const yValues = data.map(d => d.y);
            
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            
            const xRange = xMax - xMin;
            const yRange = yMax - yMin;
            
            console.log(`üìä Original coordinate ranges: X[${xMin.toFixed(2)}, ${xMax.toFixed(2)}], Y[${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
            
            // Normalize to 0-100
            const normalized = data.map(d => ({
                timestamp: d.timestamp,
                x: xRange > 0 ? ((d.x - xMin) / xRange) * 100 : 50,
                y: yRange > 0 ? ((d.y - yMin) / yRange) * 100 : 50,
                fixation_duration: d.fixation_duration,
                pupil_size: d.pupil_size
            }));
            
            console.log(`‚úÖ Normalized to 0-100 range`);
            
            return normalized;
        }
        
        // Update coordinate mode - ONLY affects uploaded data
        function updateCoordinateMode() {
            const mode = document.getElementById('coordinate-mode').value;
            coordinateMode = mode;
            
            if (uploadedRawData.length > 0) {
                console.log(`üîÑ Switched to ${mode} coordinates for uploaded data`);
                
                // Update summary with current mode
                const currentData = mode === 'raw' ? uploadedRawData : uploadedNormalizedData;
                displayDataSummary(currentData);
                
                // Re-visualize if plot exists
                const plotDiv = document.getElementById('upload-plot');
                if (plotDiv && plotDiv.data && plotDiv.data.length > 0) {
                    visualizeUploadedData();
                }
            }
        }
        
        // Display data summary - ONLY for uploaded data
        function displayDataSummary(data) {
            const summary = document.getElementById('data-summary');
            
            const xValues = data.map(d => d.x);
            const yValues = data.map(d => d.y);
            const xMin = Math.min(...xValues);
            const xMax = Math.max(...xValues);
            const yMin = Math.min(...yValues);
            const yMax = Math.max(...yValues);
            
            const stats = {
                points: data.length,
                duration: ((data[data.length-1].timestamp - data[0].timestamp) / 1000).toFixed(2),
                avgX: (data.reduce((sum, d) => sum + d.x, 0) / data.length).toFixed(2),
                avgY: (data.reduce((sum, d) => sum + d.y, 0) / data.length).toFixed(2),
                xRange: `[${xMin.toFixed(1)}, ${xMax.toFixed(1)}]`,
                yRange: `[${yMin.toFixed(1)}, ${yMax.toFixed(1)}]`
            };
            
            const modeLabel = coordinateMode === 'raw' ? 
                'üéØ Raw screen coordinates (perfect for stimulus overlay)' : 
                'üìä Normalized 0-100 (for AI comparison)';
            
            summary.innerHTML = `
                <p><strong>Total Points:</strong> ${stats.points}</p>
                <p><strong>Duration:</strong> ${stats.duration} seconds</p>
                <p><strong>Average X:</strong> ${stats.avgX} (Range: ${stats.xRange})</p>
                <p><strong>Average Y:</strong> ${stats.avgY} (Range: ${stats.yRange})</p>
                <p style="color: #667eea; font-size: 0.9em; margin-top: 10px;"><em>${modeLabel}</em></p>
            `;
        }
        
        // Visualize uploaded data - ONLY uses uploaded data variables
        function visualizeUploadedData() {
            if (uploadedRawData.length === 0) {
                showStatus('upload-status', '‚ùå No data to visualize', 'error');
                return;
            }
            
            // Use the correct data based on coordinate mode
            let dataToVisualize = coordinateMode === 'raw' ? uploadedRawData : uploadedNormalizedData;
            
            // Check if all coordinates are zero (parsing issue)
            const allZeros = dataToVisualize.every(d => d.x === 0 && d.y === 0);
            if (allZeros) {
                showStatus('upload-status', '‚ö†Ô∏è Warning: All coordinates are zero. Check CSV format (expected columns: x, y or gaze_x, gaze_y)', 'error');
                console.error('‚ùå CSV parsing issue - all coordinates are 0,0');
                return;
            }
            
            // Downsample if too many points (max 5000 for smooth rendering)
            const MAX_POINTS = 5000;
            if (dataToVisualize.length > MAX_POINTS) {
                const samplingRate = Math.ceil(dataToVisualize.length / MAX_POINTS);
                const sampledData = dataToVisualize.filter((_, index) => index % samplingRate === 0);
                console.log(`‚ö†Ô∏è Downsampling: ${dataToVisualize.length} ‚Üí ${sampledData.length} points (every ${samplingRate}th point)`);
                dataToVisualize = sampledData;
                
                showStatus('upload-status', `üìä Visualizing ${sampledData.length} sampled points (from ${uploadedRawData.length} total)`, 'info');
            }
            
            const plotType = document.getElementById('upload-plot-type').value;
            
            console.log(`üìä Visualizing ${dataToVisualize.length} points in ${coordinateMode} mode`);
            
            // Show sample of data being visualized
            if (dataToVisualize.length > 0) {
                console.log('üìç Sample points:', dataToVisualize.slice(0, 5).map(d => `(${d.x.toFixed(2)}, ${d.y.toFixed(2)})`).join(', '));
            }
            
            // Visualize in upload-plot container ONLY
            visualizePlot('upload-plot', dataToVisualize, plotType, `Uploaded Data (${coordinateMode} coordinates)`);
        }
        
        // Compare to baseline - ONLY uses uploaded normalized data
        async function compareToBaseline() {
            if (uploadedRawData.length === 0) {
                showStatus('upload-status', '‚ùå No data loaded. Please upload CSV first.', 'error');
                return;
            }
            
            if (!baselineModel || !baselineModel.isModelLoaded) {
                showStatus('upload-status', '‚ùå AI model not loaded', 'error');
                return;
            }
            
            // Always use normalized data for AI comparison
            const dataForComparison = uploadedNormalizedData;
            
            if (coordinateMode === 'raw') {
                console.log('‚ö†Ô∏è AI comparison requires normalized coordinates. Automatically using normalized data.');
            }
            
            console.log(`ü§ñ Comparing ${dataForComparison.length} normalized data points to ${currentAgeGroup} baseline`);
            
            // Switch to AI Analysis tab
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('ai-analysis').classList.add('active');
            document.querySelectorAll('.tab-button')[2].classList.add('active');
            
            // Show loading
            document.getElementById('ai-loading').style.display = 'block';
            document.getElementById('ai-results').style.display = 'none';
            
            try {
                const results = await baselineModel.compareToBaseline(dataForComparison);
                
                // Hide loading
                document.getElementById('ai-loading').style.display = 'none';
                document.getElementById('ai-results').style.display = 'block';
                
                // Display results
                document.getElementById('similarity-score').textContent = results.similarityScore + '%';
                document.getElementById('interpretation').textContent = results.interpretation;
                
                // Detailed metrics
                document.getElementById('detailed-metrics').innerHTML = `
                    <p><strong>Reconstruction Error:</strong> ${results.reconstructionError.toFixed(4)}</p>
                    <p><strong>Data Points:</strong> ${dataForComparison.length}</p>
                    <p><strong>Features Analyzed:</strong> 28</p>
                `;
                
                // Feature analysis (top deviations)
                const featureNames = ['X Mean', 'X Std', 'X Min', 'X Max', 'Y Mean', 'Y Std', 'Y Min', 'Y Max',
                    'Fixation Duration Mean', 'Fixation Duration Std', 'Fixation Count', 'Saccade Velocity Mean',
                    'Saccade Velocity Std', 'Saccade Amplitude Mean', 'Saccade Amplitude Std', 'Pupil Size Mean',
                    'Pupil Size Std', 'Spatial Coverage', 'Fixation Dispersion', 'Scan Path Length',
                    'Gaze Entropy', 'Center Bias', 'Edge Bias', 'ROI Focus', 'V/H Ratio',
                    'Temporal Consistency', 'Attention Switches', 'Revisit Rate'];
                
                // Display feature analysis if available
                if (results.zScores && results.zScores.length > 0) {
                    let featureHTML = '<table style="width:100%; border-collapse: collapse;">';
                    featureHTML += '<tr><th style="text-align:left; padding: 5px; border-bottom: 1px solid #ddd;">Feature</th>';
                    featureHTML += '<th style="text-align:right; padding: 5px; border-bottom: 1px solid #ddd;">Z-Score</th></tr>';
                    
                    results.zScores.forEach((z, i) => {
                        const absZ = Math.abs(z);
                        if (absZ > 1.5) {  // Show significant deviations
                            const color = absZ > 2 ? '#dc3545' : '#ffc107';
                            featureHTML += `<tr style="background: ${color}22;">`;
                            featureHTML += `<td style="padding: 5px;">${featureNames[i]}</td>`;
                            featureHTML += `<td style="padding: 5px; text-align: right;">${z.toFixed(2)}</td>`;
                            featureHTML += '</tr>';
                        }
                    });
                    
                    featureHTML += '</table>';
                    document.getElementById('feature-analysis').innerHTML = featureHTML;
                } else {
                    // If no z-scores available, show a simple message
                    document.getElementById('feature-analysis').innerHTML = 
                        '<p style="padding: 10px; color: #666;">Feature analysis based on reconstruction error only.</p>';
                }
                
                showStatus('ai-status', '‚úÖ Analysis complete!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error during comparison:', error);
                document.getElementById('ai-loading').style.display = 'none';
                showStatus('ai-status', `‚ùå Error: ${error.message}`, 'error');
            }
        }
        
        // Visualization function - optimized for large datasets
        function visualizePlot(containerId, data, plotType, title) {
            console.log(`üé® Starting visualization: ${data.length} points, type: ${plotType}`);
            
            // Clear any existing plot first
            const container = document.getElementById(containerId);
            Plotly.purge(container);
            
            const x = data.map(d => d.x);
            const y = data.map(d => d.y);
            
            const xMin = Math.min(...x);
            const xMax = Math.max(...x);
            const yMin = Math.min(...y);
            const yMax = Math.max(...y);
            
            console.log(`üìä X range: [${xMin.toFixed(2)}, ${xMax.toFixed(2)}]`);
            console.log(`üìä Y range: [${yMin.toFixed(2)}, ${yMax.toFixed(2)}]`);
            
            // Check if data is valid
            if (xMin === xMax && yMin === yMax) {
                console.error('‚ùå All points have the same coordinates!');
                document.getElementById(containerId).innerHTML = 
                    `<div style="padding: 20px; color: red;">
                        <h3>‚ö†Ô∏è Invalid Data</h3>
                        <p>All data points have the same coordinates (${xMin.toFixed(2)}, ${yMin.toFixed(2)})</p>
                        <p>Please check your CSV file format and column names.</p>
                    </div>`;
                return;
            }
            
            let plotData;
            
            // Common layout settings
            const layout = {
                title: title,
                xaxis: { 
                    title: 'X Position',
                    autorange: true
                },
                yaxis: { 
                    title: 'Y Position',
                    autorange: 'reversed'  // Eye-tracking typically has Y increasing downward
                },
                height: 600,
                hovermode: 'closest',
                showlegend: false
            };
            
            switch(plotType) {
                case 'scatter':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        marker: {
                            size: 5,
                            color: data.map((d, i) => i),
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {
                                title: 'Sequence'
                            }
                        }
                    }];
                    break;
                    
                case 'heatmap':
                    // Use histogram2d for large datasets
                    plotData = [{
                        x: x,
                        y: y,
                        type: 'histogram2d',
                        colorscale: 'Hot',
                        reversescale: true,
                        nbinsx: 50,
                        nbinsy: 50,
                        colorbar: {
                            title: 'Fixation<br>Density'
                        }
                    }];
                    layout.title = title + ' - Fixation Density';
                    break;
                    
                case 'path':
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'lines+markers',
                        type: 'scatter',
                        line: { 
                            color: '#667eea', 
                            width: 1 
                        },
                        marker: { 
                            size: 3, 
                            color: '#764ba2' 
                        }
                    }];
                    layout.title = title + ' - Scan Path';
                    break;
                    
                case 'histogram':
                    // Show distribution of X and Y separately
                    plotData = [
                        {
                            x: x,
                            type: 'histogram',
                            name: 'X Distribution',
                            marker: { color: '#667eea' },
                            opacity: 0.7,
                            nbinsx: 30
                        },
                        {
                            x: y,
                            type: 'histogram',
                            name: 'Y Distribution',
                            marker: { color: '#764ba2' },
                            opacity: 0.7,
                            nbinsx: 30
                        }
                    ];
                    layout.xaxis.title = 'Position (pixels)';
                    layout.yaxis.title = 'Frequency';
                    layout.yaxis.autorange = true; // Don't reverse for histogram
                    layout.barmode = 'overlay';
                    layout.showlegend = true;
                    layout.title = title + ' - Position Distribution';
                    break;
                    
                case 'density':
                    // Density contour plot
                    plotData = [{
                        x: x,
                        y: y,
                        type: 'histogram2dcontour',
                        colorscale: 'Viridis',
                        contours: {
                            showlabels: true,
                            labelfont: {
                                family: 'Raleway',
                                size: 12,
                                color: 'white'
                            }
                        },
                        colorbar: {
                            title: 'Density'
                        }
                    }];
                    layout.title = title + ' - Density Contour';
                    break;
                    
                case '3d':
                    // 3D trajectory with time as Z-axis
                    const timestamps = data.map(d => d.timestamp);
                    plotData = [{
                        x: x,
                        y: y,
                        z: timestamps,
                        mode: 'markers+lines',
                        type: 'scatter3d',
                        marker: {
                            size: 3,
                            color: timestamps,
                            colorscale: 'Viridis',
                            showscale: true,
                            colorbar: {
                                title: 'Time'
                            }
                        },
                        line: {
                            color: '#667eea',
                            width: 2
                        }
                    }];
                    layout.scene = {
                        xaxis: { title: 'X Position' },
                        yaxis: { title: 'Y Position' },
                        zaxis: { title: 'Time (ms)' }
                    };
                    layout.title = title + ' - 3D Trajectory';
                    delete layout.xaxis;
                    delete layout.yaxis;
                    break;
                    
                case 'temporal':
                    // X and Y positions over time
                    const times = data.map(d => d.timestamp);
                    plotData = [
                        {
                            x: times,
                            y: x,
                            mode: 'lines',
                            name: 'X Position',
                            line: { color: '#667eea', width: 2 }
                        },
                        {
                            x: times,
                            y: y,
                            mode: 'lines',
                            name: 'Y Position',
                            line: { color: '#764ba2', width: 2 }
                        }
                    ];
                    layout.xaxis.title = 'Time (ms)';
                    layout.yaxis.title = 'Position (pixels)';
                    layout.yaxis.autorange = true; // Don't reverse for temporal
                    layout.showlegend = true;
                    layout.title = title + ' - Temporal Analysis';
                    break;
                    
                default:
                    plotData = [{
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        marker: { 
                            size: 5,
                            color: '#667eea'
                        }
                    }];
            }
            
            // Use responsive layout with proper config
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };
            
            console.log('üé® Rendering plot with Plotly...');
            console.log(`üìä Plot data: ${plotData[0].x.length} x-values, ${plotData[0].y.length} y-values`);
            
            // Render with error handling
            Plotly.newPlot(containerId, plotData, layout, config)
                .then(() => {
                    console.log('‚úÖ Plot rendered successfully');
                })
                .catch(error => {
                    console.error('‚ùå Plotly rendering error:', error);
                    document.getElementById(containerId).innerHTML = 
                        `<div style="padding: 20px; color: red;">
                            <h3>Visualization Error</h3>
                            <p>${error.message}</p>
                            <p>Try reducing the data size or selecting a different plot type.</p>
                        </div>`;
                });
        }
        
        // Initialize animations on page load
        window.addEventListener('load', () => {
            // Create circular text animation
            const container = document.getElementById('circularTextContainer');
            if (container) {
                const text = 'Eye-Tracking Data Visualizer';
                const circularDiv = document.createElement('div');
                circularDiv.className = 'circular-text';
                
                const chars = text.split('');
                const angleStep = 360 / chars.length;
                
                chars.forEach((char, i) => {
                    const span = document.createElement('span');
                    span.textContent = char;
                    span.style.transform = `rotate(${i * angleStep}deg)`;
                    span.style.animationDelay = `${i * 0.03}s`;
                    circularDiv.appendChild(span);
                });
                
                container.appendChild(circularDiv);
            }
            
            // Stagger control section animations
            document.querySelectorAll('.control-section').forEach((section, i) => {
                section.style.animationDelay = `${0.2 + (i * 0.15)}s`;
            });
            
            // Stagger info card animations
            document.querySelectorAll('.info-card').forEach((card, i) => {
                card.style.animationDelay = `${0.3 + (i * 0.1)}s`;
            });
        });
    </script>
</body>
</html>
